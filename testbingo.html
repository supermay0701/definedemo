<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–ç­–ç•¥å›æ¸¬ç³»çµ± 4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --text: #f8fafc; --text-muted: #94a3b8; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; position: relative; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* æ§åˆ¶é¢æ¿å€ */
        .controls { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        input, select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: white; font-size: 16px; text-align: center; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button.btn-fun { background: #8b5cf6; background-image: linear-gradient(to right, #8b5cf6, #d946ef); }
        button.btn-fun:hover { background-image: linear-gradient(to right, #7c3aed, #c026d3); }
        
        /* é æ¸¬å¡ç‰‡å€ */
        .prediction-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px; }
        .pred-card { background: var(--bg); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card-markov::before { background: #f59e0b; } .card-streak::before { background: #06b6d4; } .card-combo::before { background: #ec4899; } .card-random::before { background: #10b981; }
        .pred-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 0.85em; color: var(--text-muted); margin-bottom: 15px; min-height: 40px; }
        .pred-numbers { min-height: 50px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        
        /* çƒé«”è¨­è¨ˆ */
        .ball { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; font-size: 18px; color: #1e293b; text-shadow: 0 1px 0 rgba(255,255,255,0.5); box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), inset 2px 2px 6px rgba(255,255,255,0.8); animation: popIn 0.3s ease-out forwards; }
        .ball-markov { background: radial-gradient(circle at 30% 30%, #fcd34d, #f59e0b); }
        .ball-streak { background: radial-gradient(circle at 30% 30%, #67e8f9, #06b6d4); }
        .ball-combo { background: radial-gradient(circle at 30% 30%, #f472b6, #ec4899); color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.5); }
        .ball-random { background: radial-gradient(circle at 30% 30%, #6ee7b7, #10b981); }
        
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        /* çµ±è¨ˆå€ */
        .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 1.1em; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        
        #version-badge { position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.8); color: var(--text-muted); padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 0.85em; border: 1px solid var(--border); }
    </style>
</head>
<body>
    <div id="version-badge">Loading version...</div>

    <div class="container">
        <h2>Bingo çŸ©é™£é‡åŒ–èˆ‡æŠ•è³‡çµ„åˆå¼•æ“ 4.0</h2>
        
        <div class="panel controls">
            <div><label>æŠ“å–è¿‘</label> <input type="number" id="fetchDays" value="5"> <label>å¤©è³‡æ–™</label></div>
            <div><label>è¨“ç·´çª—å£:</label> <input type="number" id="windowSize" value="200"> <label>æœŸ</label></div>
            <div>
                <label>ç›®æ¨™ç©æ³•:</label> 
                <select id="starSelect">
                    <option value="1">1 æ˜Ÿ (å–®æŒ‘)</option>
                    <option value="2">2 æ˜Ÿ</option>
                    <option value="3">3 æ˜Ÿ</option>
                    <option value="4" selected>4 æ˜Ÿ (æ¨è–¦)</option>
                    <option value="5">5 æ˜Ÿ</option>
                    <option value="6">6 æ˜Ÿ</option>
                    <option value="8">8 æ˜Ÿ</option>
                    <option value="10">10 æ˜Ÿ (å¤§åŒ…ç‰Œ)</option>
                </select>
            </div>
            <button onclick="runBacktest()">ğŸš€ åŸ·è¡Œæ·±åº¦å›æ¸¬èˆ‡é æ¸¬</button>
            <p id="status" style="color: var(--text-muted); width: 100%; margin: 5px 0 0 0;">ç³»çµ±é–’ç½®ä¸­...</p>
        </div>
        
        <div class="panel" id="predictionPanel" style="display: none;">
            <h3>ğŸ¯ æŠ•è³‡çµ„åˆå»ºè­° (åŸºæ–¼æœ€æ–°ä¸€æœŸå‹•æ…‹ç”Ÿæˆ)</h3>
            <div class="prediction-box">
                <div class="pred-card card-markov">
                    <div class="pred-title" style="color: #f59e0b;">ğŸ”— æ¢ä»¶æ©Ÿç‡ (æ‹–ç‰Œ)</div>
                    <div class="desc">æ­·å²æ•¸æ“šä¸­ï¼Œè¢«ç•¶å‰è™Ÿç¢¼å¼·çƒˆå¸å¼•å‡ºåœŸçš„è·Ÿå±èŸ²ã€‚</div>
                    <div class="pred-numbers" id="predMarkov"></div>
                </div>
                <div class="pred-card card-streak">
                    <div class="pred-title" style="color: #06b6d4;">ğŸ§² è‡ªç›¸é—œæ€§ (é€£èŠ)</div>
                    <div class="desc">å¾å‰›é–‹å‡ºçš„çƒä¸­ï¼Œæ‰¾å‡ºå…·å‚™æœ€å¼·ã€Œå­˜æ´»å‹•èƒ½ã€çš„è™Ÿç¢¼ã€‚</div>
                    <div class="pred-numbers" id="predStreak"></div>
                </div>
                <div class="pred-card card-combo">
                    <div class="pred-title" style="color: #ec4899;">ğŸŒŸ 4æ˜Ÿå…±æŒ¯ (é©åˆé¤Šç‰Œ)</div>
                    <div class="desc">å¼·åˆ¶é–å®š4é¡†ã€‚çµåˆæ‹–ç‰Œèˆ‡é€£èŠé›™é‡æ¬Šé‡ï¼Œæ‰¾å‡ºæ•¸å­¸ä¸Šæœ€å …å›ºçš„çµ„åˆï¼Œé©åˆé€£å‡¹10æœŸã€‚</div>
                    <div class="pred-numbers" id="predCombo"></div>
                </div>
                <div class="pred-card card-random">
                    <div class="pred-title" style="color: #10b981;">ğŸ² é‡å­åç¸® (é›»è…¦é¸è™Ÿ)</div>
                    <div class="desc">æ”¾æ£„æ•¸å­¸ï¼Œäº¤çµ¦å®‡å®™çš„ç†µã€‚æ¸¬è©¦ä½ çš„ç´”ç²¹é‹æ°£ã€‚</div>
                    <button class="btn-fun" onclick="generateRandom()" style="margin-bottom: 15px;">ğŸ”® é‡æ–°åç¸®</button>
                    <div class="pred-numbers" id="predRandom"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3 style="margin-bottom: 10px;">ğŸ“ˆ æ­·å²ç´¯ç©å‘½ä¸­èµ°å‹¢åœ– (æª¢å®šæ¼”ç®—æ³•æœ‰æ•ˆæ€§)</h3>
            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*æ­¤åœ–è¡¨é¡¯ç¤ºè©²æ˜Ÿæ•¸ç©æ³•åœ¨æ­·å²å€é–“å…§ã€Œå¯¦éš›æŠ“ä¸­çƒæ•¸ã€çš„ç´¯ç©æ›²ç·šã€‚æ–œç‡è¶Šé™¡ä»£è¡¨æŠ“ç‰ŒåŠ›è¶Šå¼·ã€‚</p>
            <canvas id="backtestChart" width="1000" height="350"></canvas>
            <div class="stats" id="finalStats"></div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸš¨ é€™è£¡å¿…é ˆæ‰‹å‹•æ›¿æ›ç‚ºä½ æœ€æ–°çš„ GAS Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        const APP_VERSION = "v4.0.0 (Portfolio Edition)"; 
        // ============================================

        document.getElementById('version-badge').innerText = APP_VERSION;
        let chartInstance = null;
        let currentStarTarget = 4; // é è¨­æ˜Ÿæ•¸

        function formatBalls(arr, styleClass) {
            return arr.map(num => `<div class="ball ${styleClass}">${num < 10 ? '0'+num : num}</div>`).join('');
        }

        // --- æ ¸å¿ƒæ¼”ç®—æ³•åº« ---

        // 1. é¦¬å¯å¤«æ‹–ç‰Œ (å›å‚³å®Œæ•´ 80 é¡†çƒçš„æ’åº)
        function getMarkovRank(history, currentDraw) {
            let nextCounts = new Array(81).fill(0);
            for (let i = 0; i < history.length - 1; i++) {
                let prev = history[i].numbers;
                let next = history[i+1].numbers;
                let matchWeight = currentDraw.filter(n => prev.includes(n)).length;
                if (matchWeight > 0) {
                    next.forEach(num => nextCounts[num] += matchWeight);
                }
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            return indices.sort((a, b) => nextCounts[b] - nextCounts[a]);
        }

        // 2. é€£èŠå­˜æ´»ç‡ (å›å‚³æ‰€æœ‰çƒçš„æ’åºï¼Œä¸åƒ…é™ç•¶å‰çƒï¼Œå› ç‚ºæˆ‘å€‘è¦å– Top N)
        function getStreakRank(history, currentDraw) {
            let survivalRates = {};
            for (let n = 1; n <= 80; n++) {
                let appearCount = 0;
                let survivedCount = 0;
                for (let i = 0; i < history.length - 1; i++) {
                    if (history[i].numbers.includes(n)) {
                        appearCount++;
                        if (history[i+1].numbers.includes(n)) survivedCount++;
                    }
                }
                // å¦‚æœæ˜¯æœ¬æœŸå‰›é–‹å‡ºçš„çƒï¼Œçµ¦äºˆé¡å¤–æ¬Šé‡åŠ æˆ (å› ç‚ºé€£èŠå®šç¾©æ˜¯åŸºæ–¼æœ¬æœŸ)
                let baseRate = appearCount > 0 ? (survivedCount / appearCount) : 0;
                survivalRates[n] = currentDraw.includes(n) ? baseRate * 1.5 : baseRate * 0.5; 
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            return indices.sort((a, b) => survivalRates[b] - survivalRates[a]);
        }

        // 3. ç¶œåˆå…±æŒ¯æ¬Šé‡ (å°‹æ‰¾é•·ç·šæœ€ç©©å®šçš„ 4 é¡†çƒ)
        function getEnsemble4Star(markovRank, streakRank) {
            let combinedScores = {};
            for (let i = 1; i <= 80; i++) {
                // æ’åè¶Šå‰é¢ï¼Œæ•¸å­—è¶Šå°ã€‚ç›¸åŠ è¶Šå°ä»£è¡¨ç¶œåˆå¯¦åŠ›è¶Šå¼·
                let mRank = markovRank.indexOf(i);
                let sRank = streakRank.indexOf(i);
                combinedScores[i] = mRank + sRank; 
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            // ç”±å°åˆ°å¤§æ’åº (åæ¬¡ç¸½å’Œæœ€å°çš„åœ¨å‰é¢)ï¼Œä¸¦å›ºå®šå– 4 é¡†
            return indices.sort((a, b) => combinedScores[a] - combinedScores[b]).slice(0, 4);
        }

        // 4. ççŒœç”¢ç”Ÿå™¨
        function generateRandom() {
            let nums = [];
            while(nums.length < currentStarTarget) {
                let r = Math.floor(Math.random() * 80) + 1;
                if(!nums.includes(r)) nums.push(r);
            }
            // æ’åºè®“ç•«é¢å¥½çœ‹
            nums.sort((a, b) => a - b);
            document.getElementById('predRandom').innerHTML = formatBalls(nums, 'ball-random');
            return nums;
        }

        // --- ä¸»æµç¨‹èˆ‡å›æ¸¬ ---

        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const days = parseInt(document.getElementById('fetchDays').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);
            currentStarTarget = parseInt(document.getElementById('starSelect').value);
            
            const limit = days * 205; 
            
            statusEl.innerText = `â³ æ­£åœ¨å¾é›²ç«¯æå–è¿‘ ${days} å¤© (ç´„ ${limit} æœŸ) çš„è³‡æ–™...`;
            document.getElementById('predictionPanel').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                if (!resJson.success) throw new Error(resJson.error);
                
                const data = resJson.data;
                if (data.length <= windowSize) {
                    statusEl.innerText = `ğŸš¨ éŒ¯èª¤ï¼šè³‡æ–™é‡ä¸è¶³ã€‚å¯¦éš›å–å¾— ${data.length} æœŸï¼Œä½†è¨“ç·´çª—å£ç‚º ${windowSize} æœŸã€‚`;
                    return;
                }

                statusEl.innerText = `âœ… æˆåŠŸè¼‰å…¥ ${data.length} æœŸè³‡æ–™ã€‚é–‹å§‹åŸ·è¡Œå¤šå› å­çŸ©é™£å›æ¸¬ (ç›®æ¨™: ${currentStarTarget} æ˜Ÿ)...`;
                
                setTimeout(() => executeStrategies(data, windowSize), 50);
                
            } catch (error) {
                statusEl.innerText = `ğŸš¨ é€£ç·šéŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize) {
            let labels = [];
            let markovHitsData = [];
            let streakHitsData = [];
            let comboHitsData = []; // 4æ˜Ÿé¤Šç‰Œçš„ç´¯ç©å‘½ä¸­
            
            let hits = { markov: 0, streak: 0, combo: 0 };
            
            for (let i = windowSize; i < data.length; i++) {
                const historyWindow = data.slice(i - windowSize, i); 
                const currentDraw = data[i-1].numbers; 
                const targetDraw = new Set(data[i].numbers); 
                labels.push(data[i].id);

                // å–å¾—å®Œæ•´æ’å
                const mRank = getMarkovRank(historyWindow, currentDraw);
                const sRank = getStreakRank(historyWindow, currentDraw);
                
                // æ ¹æ“šä½¿ç”¨è€…é¸å®šçš„æ˜Ÿæ•¸ï¼Œåˆ‡å‡º N é¡†çƒä¾†è¨ˆç®—å‘½ä¸­ç‡
                const markovPred = mRank.slice(0, currentStarTarget);
                const streakPred = sRank.slice(0, currentStarTarget);
                // å…±æŒ¯ç­–ç•¥å›ºå®šç‚º 4 æ˜Ÿ
                const comboPred = getEnsemble4Star(mRank, sRank);

                hits.markov += markovPred.filter(n => targetDraw.has(n)).length;
                hits.streak += streakPred.filter(n => targetDraw.has(n)).length;
                hits.combo += comboPred.filter(n => targetDraw.has(n)).length;

                markovHitsData.push(hits.markov);
                streakHitsData.push(hits.streak);
                comboHitsData.push(hits.combo);
            }

            // --- å¯¦æˆ°é æ¸¬æœ€æ–°ä¸€æœŸ ---
            const latestHistory = data.slice(data.length - windowSize);
            const absoluteCurrentDraw = data[data.length - 1].numbers; 
            
            const finalMRank = getMarkovRank(latestHistory, absoluteCurrentDraw);
            const finalSRank = getStreakRank(latestHistory, absoluteCurrentDraw);
            
            const nextMarkov = finalMRank.slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextStreak = finalSRank.slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextCombo = getEnsemble4Star(finalMRank, finalSRank).sort((a,b)=>a-b);

            // æ¸²æŸ“å‰ç«¯é¢æ¿
            document.getElementById('predMarkov').innerHTML = formatBalls(nextMarkov, 'ball-markov');
            document.getElementById('predStreak').innerHTML = formatBalls(nextStreak, 'ball-streak');
            document.getElementById('predCombo').innerHTML = formatBalls(nextCombo, 'ball-combo');
            generateRandom(); // è§¸ç™¼ççŒœæ¸²æŸ“
            
            document.getElementById('predictionPanel').style.display = 'block';

            // --- è¨ˆç®—çœŸå¯¦æœŸæœ›å€¼èˆ‡å›å ± ---
            // æ¯æ¬¡é æ¸¬çš„çƒæ•¸ç¸½å’Œ
            const totalBallsPredicted = (data.length - windowSize) * currentStarTarget; 
            const totalComboBalls = (data.length - windowSize) * 4; // å›ºå®š4æ˜Ÿ
            
            // ç†è«–ä¸Šå–®é¡†çƒå‘½ä¸­çš„æ©Ÿç‡æ˜¯ 25%ã€‚
            document.getElementById('finalStats').innerHTML = `
                <div style="color: #f59e0b">ğŸ”— æ‹–ç‰ŒæŠ“çƒç‡: ${((hits.markov / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #06b6d4">ğŸ§² é€£èŠæŠ“çƒç‡: ${((hits.streak / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #ec4899">ğŸŒŸ 4æ˜Ÿå…±æŒ¯æŠ“çƒç‡: ${((hits.combo / totalComboBalls)*100).toFixed(2)}%</div>
                <div style="color: var(--text-muted)">ğŸ² ç†è«–åŸºæº–ç·š: 25.00%</div>
            `;
            document.getElementById('status').innerText = "âœ… çŸ©é™£é‹ç®—å®Œæˆï¼å·²ç‚ºæ‚¨ç”¢ç”Ÿæœ€ä½³æŠ•è³‡çµ„åˆã€‚";

            renderChart(labels, markovHitsData, streakHitsData, comboHitsData);
        }

        function renderChart(labels, markovData, streakData, comboData) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: `ğŸ”— æ‹–ç‰Œç­–ç•¥ (${currentStarTarget}æ˜Ÿ)`, data: markovData, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: `ğŸ§² é€£èŠç­–ç•¥ (${currentStarTarget}æ˜Ÿ)`, data: streakData, borderColor: '#06b6d4', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: `ğŸŒŸ 4æ˜Ÿå…±æŒ¯ (å›ºå®š4æ˜Ÿ)`, data: comboData, borderColor: '#ec4899', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 15 } },
                        y: { display: true, title: { display: true, text: 'ç´¯ç©å‘½ä¸­ç¸½çƒæ•¸', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#f8fafc' } } }
                }
            });
        }
    </script>
</body>
</html>
