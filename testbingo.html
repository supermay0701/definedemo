<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–èˆ‡è³‡ç”¢é…ç½®ç³»çµ± 6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --text: #f8fafc; --text-muted: #94a3b8; --accent: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; position: relative; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* æ§åˆ¶é¢æ¿å€ */
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .control-item { display: flex; align-items: center; background: #0f172a; padding: 5px 10px; border-radius: 8px; border: 1px solid #334155;}
        input[type="number"], select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: white; font-size: 15px; text-align: center; margin: 0 8px;}
        button { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button.btn-fun { background: #8b5cf6; background-image: linear-gradient(to right, #8b5cf6, #d946ef); width: 100%; margin-top: 10px; padding: 8px;}
        button.btn-fun:hover { background-image: linear-gradient(to right, #7c3aed, #c026d3); }
        
        /* é ç±¤è¨­è¨ˆ */
        .tabs { display: flex; gap: 10px; margin-bottom: -1px; }
        .tab-btn { background: var(--panel); color: var(--text-muted); border: 1px solid var(--border); border-bottom: none; padding: 12px 24px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; box-shadow: none; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tab-content { display: none; background: var(--panel); padding: 20px; border-radius: 0 8px 8px 8px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
        .tab-content.active { display: block; }

        /* é æ¸¬å¡ç‰‡å€ */
        .prediction-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .pred-card { background: var(--bg); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column;}
        .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card-markov::before { background: #f59e0b; } .card-streak::before { background: #06b6d4; } .card-combo::before { background: #ec4899; } .card-random::before { background: #10b981; }
        .pred-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; justify-content: center;}
        .desc { font-size: 0.8em; color: var(--text-muted); margin-bottom: 10px; min-height: 35px; line-height: 1.4;}
        .pred-numbers { min-height: 45px; display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; flex-grow: 1; align-items: center;}
        
        /* çƒé«”è¨­è¨ˆ */
        .ball { display: flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; font-weight: bold; font-size: 16px; color: #1e293b; box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), inset 2px 2px 6px rgba(255,255,255,0.8); animation: popIn 0.3s ease-out forwards; }
        .ball-markov { background: radial-gradient(circle at 30% 30%, #fcd34d, #f59e0b); }
        .ball-streak { background: radial-gradient(circle at 30% 30%, #67e8f9, #06b6d4); }
        .ball-combo { background: radial-gradient(circle at 30% 30%, #f472b6, #ec4899); color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.5); }
        .ball-random { background: radial-gradient(circle at 30% 30%, #6ee7b7, #10b981); }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        /* çµ±è¨ˆå€ */
        .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 1em; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px;}
        .pnl-positive { color: #10b981; font-weight: bold; }
        .pnl-negative { color: #ef4444; font-weight: bold; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; margin: 0 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ec4899; box-shadow: 0 0 10px #ec4899; }
        input:checked + .slider:before { transform: translateX(20px); }

        #version-badge { position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.8); color: var(--text-muted); padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 0.85em; border: 1px solid var(--border); }
    </style>
</head>
<body>
    <div id="version-badge">Loading version...</div>

    <div class="container">
        <h2>Bingo çŸ©é™£é‡åŒ–èˆ‡æŠ•è³‡çµ„åˆå¼•æ“ 6.0</h2>
        
        <div class="panel controls">
            <div class="control-item">
                <label>è¿‘</label> <input type="number" id="fetchDays" value="5" style="width: 50px;"> <label>å¤©è³‡æ–™</label>
            </div>
            <div class="control-item">
                <label>çª—å£:</label> <input type="number" id="windowSize" value="200" style="width: 60px;"> <label>æœŸ</label>
            </div>
            <div class="control-item">
                <label>æ˜Ÿæ•¸:</label> 
                <select id="starSelect">
                    <option value="1">1 æ˜Ÿ</option><option value="2">2 æ˜Ÿ</option><option value="3">3 æ˜Ÿ</option>
                    <option value="4" selected>4 æ˜Ÿ</option><option value="5">5 æ˜Ÿ</option><option value="6">6 æ˜Ÿ</option>
                    <option value="7">7 æ˜Ÿ</option><option value="8">8 æ˜Ÿ</option><option value="9">9 æ˜Ÿ</option><option value="10">10 æ˜Ÿ</option>
                </select>
            </div>
            <div class="control-item" style="border-color: #ec4899;">
                <label style="color: #ec4899; font-weight: bold;">ğŸ çé‡‘åŠ å€æ¨¡å¼</label>
                <label class="switch">
                    <input type="checkbox" id="bonusToggle">
                    <span class="slider"></span>
                </label>
            </div>

            <button onclick="runBacktest()">ğŸš€ åŸ·è¡Œæ·±åº¦å›æ¸¬</button>
        </div>
        <p id="status" style="color: var(--text-muted); margin: -10px 0 15px 5px; font-size: 0.9em;">ç³»çµ±é–’ç½®ä¸­...</p>
        
        <div class="panel" id="predictionPanel" style="display: none; padding-top: 15px;">
            <h3 style="margin-top: 0; color: #f8fafc; border-bottom: 1px solid #334155; padding-bottom: 10px; font-size: 1.1em;">ğŸ¯ æ¬¡æœŸå¯¦æˆ°æŠ•è³‡çµ„åˆ (æ ¹æ“šæœ€æ–°ä¸€æœŸæ¢ä»¶æ¨ç®—)</h3>
            <div class="prediction-box">
                <div class="pred-card card-markov">
                    <div class="pred-title" style="color: #f59e0b;">ğŸ”— æ‹–ç‰Œæ©Ÿç‡</div>
                    <div class="desc">æ­·å²æœ€å¸¸ç·Šè·Ÿç•¶å‰è™Ÿç¢¼é–‹å‡ºçš„çƒ</div>
                    <div class="pred-numbers" id="predMarkov"></div>
                </div>
                <div class="pred-card card-streak">
                    <div class="pred-title" style="color: #06b6d4;">ğŸ§² é€£èŠå‹•èƒ½</div>
                    <div class="desc">å‰›é–‹å‡ºçš„è™Ÿç¢¼ä¸­ï¼Œæ­·å²å­˜æ´»ç‡æœ€é«˜</div>
                    <div class="pred-numbers" id="predStreak"></div>
                </div>
                <div class="pred-card card-combo">
                    <div class="pred-title" style="color: #ec4899;">ğŸŒŸ 4æ˜Ÿå…±æŒ¯é¤Šç‰Œ</div>
                    <div class="desc">çµåˆæ‹–ç‰Œèˆ‡é€£èŠï¼Œå°‹æ‰¾é•·ç·šé˜²ç¦¦åŠ›æœ€å¼·çµ„åˆ (å¼·åˆ¶4é¡†)</div>
                    <div class="pred-numbers" id="predCombo"></div>
                </div>
                <div class="pred-card card-random">
                    <div class="pred-title" style="color: #10b981;">ğŸ² äº‚æ•¸ççŒœ</div>
                    <div class="desc">ç´”ç²¹æ©Ÿç‡ï¼Œæ‰“ç ´äººè…¦é¸è™Ÿåè¦‹</div>
                    <div class="pred-numbers" id="predRandom"></div>
                    <button class="btn-fun" onclick="generateRandom()">ğŸ”® é‡æ–°åç¸®</button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-hitrate')">ğŸ¯ æ­·å²å‘½ä¸­ç‡æª¢å®š</button>
            <button class="tab-btn" onclick="switchTab('tab-pnl')">ğŸ’° çœŸå¯¦è³‡é‡‘æç›Š (PnL)</button>
        </div>

        <div id="tab-hitrate" class="tab-content active">
            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*æ¯”è¼ƒç›¸åŒæ˜Ÿæ•¸ä¸‹å„ç­–ç•¥çš„ç´¯ç©å‘½ä¸­æ•¸ã€‚æ–œç‡è¶Šé™¡ä»£è¡¨æ©Ÿç‡æ¨¡å‹è¶Šæœ‰æ•ˆã€‚è‹¥è¢«è™›ç·š(ççŒœ)çºä½ï¼Œä»£è¡¨ç­–ç•¥ç„¡æ•ˆã€‚</p>
            <canvas id="hitChart" width="1000" height="350"></canvas>
            <div class="stats" id="hitStats"></div>
        </div>

        <div id="tab-pnl" class="tab-content">
            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*æ¨¡æ“¬åˆå§‹è³‡é‡‘ 0 å…ƒï¼Œæ¯æœŸæ¯æ³¨èŠ±è²» 25 å…ƒã€‚çµåˆå°å½©çœŸå¯¦è³ ç‡è¨ˆç®—æ·¨ç²åˆ©ã€‚é€™æ‰æ˜¯æ±ºå®šç”Ÿæ­»çš„æ®˜é…·æ›²ç·šã€‚</p>
            <canvas id="pnlChart" width="1000" height="350"></canvas>
            <div class="stats" id="pnlStats"></div>
        </div>

    </div>

    <script>
        // ============================================
        // ğŸš¨ é€™è£¡å¿…é ˆæ‰‹å‹•æ›¿æ›ç‚ºä½ æœ€æ–°çš„ GAS Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        const APP_VERSION = "v6.0.0 (PnL Pro Edition)"; 
        // ============================================

        document.getElementById('version-badge').innerText = APP_VERSION;
        let hitChartInstance = null;
        let pnlChartInstance = null;
        let currentStarTarget = 4;

        // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function formatBalls(arr, styleClass) {
            return arr.map(num => `<div class="ball ${styleClass}">${num < 10 ? '0'+num : num}</div>`).join('');
        }

        // --- å°å½©æ¨™æº–è³ ç‡è¡¨ (æ¯æ³¨ 25 å…ƒ) ---
        // æ ¼å¼: standardPayout[æ˜Ÿæ•¸][çŒœä¸­çƒæ•¸] = çé‡‘ (æ–°å°å¹£)
        const standardPayout = {
            1: { 1: 50, 0: 0 },
            2: { 2: 75, 1: 0, 0: 0 },
            3: { 3: 500, 2: 50, 1: 0, 0: 0 },
            4: { 4: 1000, 3: 100, 2: 25, 1: 0, 0: 0 },
            5: { 5: 7500, 4: 500, 3: 50, 2: 0, 1: 0, 0: 0 },
            6: { 6: 25000, 5: 1000, 4: 200, 3: 25, 2: 0, 1: 0, 0: 0 },
            7: { 7: 80000, 6: 3000, 5: 300, 4: 50, 3: 25, 2: 0, 1: 0, 0: 0 },
            8: { 8: 500000, 7: 20000, 6: 1000, 5: 200, 4: 25, 3: 0, 2: 0, 1: 0, 0: 25 },
            9: { 9: 1000000, 8: 100000, 7: 3000, 6: 500, 5: 100, 4: 25, 3: 0, 2: 0, 1: 0, 0: 25 },
            10: { 10: 5000000, 9: 250000, 8: 25000, 7: 2500, 6: 250, 5: 25, 4: 0, 3: 0, 2: 0, 1: 0, 0: 25 }
        };

        // --- å°å½©åŠ å€æ´»å‹•è³ ç‡è¡¨ (å‹•æ…‹è¦†å¯«ç‰ˆ) ---
        // å…ˆæ·±æ‹·è²(è¤‡è£½)ä¸€ä»½æ¨™æº–è³ ç‡ï¼Œé€™æ¨£æ²’è¢«åŠ ç¢¼çš„çé …(å¦‚4æ˜Ÿä¸­2)æ‰ä¸æœƒè®Šæˆ0å…ƒ
        const bonusPayout = JSON.parse(JSON.stringify(standardPayout)); 
        
        // ä¾ç…§ä½¿ç”¨è€…æä¾›çš„ã€ŒåŠ ç¢¼æœŸé–“çé‡‘å°ç…§è¡¨ã€ç²¾æº–è¦†å¯«
        bonusPayout[1][1] = 75;     // 1æ˜Ÿä¸­1: 50 -> 75
        
        bonusPayout[2][2] = 150;    // 2æ˜Ÿä¸­2: 75 -> 150
        
        bonusPayout[3][3] = 1000;   // 3æ˜Ÿä¸­3: 500 -> 1000
        
        bonusPayout[4][4] = 2000;   // 4æ˜Ÿä¸­4: 1000 -> 2000
        bonusPayout[4][3] = 150;    // 4æ˜Ÿä¸­3: 100 -> 150
        
        bonusPayout[5][5] = 10000;  // 5æ˜Ÿä¸­5: 7500 -> 10000
        bonusPayout[5][4] = 600;    // 5æ˜Ÿä¸­4: 500 -> 600
        
        bonusPayout[6][6] = 50000;  // 6æ˜Ÿä¸­6: 25000 -> 50000
        bonusPayout[6][5] = 1200;   // 6æ˜Ÿä¸­5: 1000 -> 1200

        // æ ¸å¿ƒè¨ˆç®—å¼•æ“ï¼šæ ¹æ“šæœ‰ç„¡æ‰“é–‹ã€ŒåŠ å€é–‹é—œã€ï¼Œçµ¦å‡ºå°æ‡‰çé‡‘
        function getPayout(star, hits, isBonusMode) {
            const table = isBonusMode ? bonusPayout : standardPayout;
            if (table[star] && table[star][hits] !== undefined) {
                return table[star][hits];
            }
            return 0; // æ²’ä¸­ç
        }

        // --- æ ¸å¿ƒæ¼”ç®—æ³•åº« (åŒä¸Š) ---
        function getMarkovRank(history, currentDraw) {
            let nextCounts = new Array(81).fill(0);
            for (let i = 0; i < history.length - 1; i++) {
                let prev = history[i].numbers;
                let next = history[i+1].numbers;
                let matchWeight = currentDraw.filter(n => prev.includes(n)).length;
                if (matchWeight > 0) next.forEach(num => nextCounts[num] += matchWeight);
            }
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => nextCounts[b] - nextCounts[a]);
        }

        function getStreakRank(history, currentDraw) {
            let survivalRates = {};
            for (let n = 1; n <= 80; n++) {
                let appearCount = 0; let survivedCount = 0;
                for (let i = 0; i < history.length - 1; i++) {
                    if (history[i].numbers.includes(n)) {
                        appearCount++;
                        if (history[i+1].numbers.includes(n)) survivedCount++;
                    }
                }
                let baseRate = appearCount > 0 ? (survivedCount / appearCount) : 0;
                survivalRates[n] = currentDraw.includes(n) ? baseRate * 1.5 : baseRate * 0.5; 
            }
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => survivalRates[b] - survivalRates[a]);
        }

        function getEnsembleRank(markovRank, streakRank) {
            let combinedScores = {};
            for (let i = 1; i <= 80; i++) combinedScores[i] = markovRank.indexOf(i) + streakRank.indexOf(i);
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => combinedScores[a] - combinedScores[b]);
        }

        function generateRandom() {
            let nums = [];
            while(nums.length < currentStarTarget) {
                let r = Math.floor(Math.random() * 80) + 1;
                if(!nums.includes(r)) nums.push(r);
            }
            nums.sort((a, b) => a - b);
            document.getElementById('predRandom').innerHTML = formatBalls(nums, 'ball-random');
            return nums;
        }

        // --- ä¸»æµç¨‹èˆ‡å›æ¸¬ ---
        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const days = parseInt(document.getElementById('fetchDays').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);
            currentStarTarget = parseInt(document.getElementById('starSelect').value);
            const isBonusMode = document.getElementById('bonusToggle').checked;
            
            const limit = days * 205; 
            statusEl.innerText = `â³ æå–é›²ç«¯æ•¸æ“šä¸­...`;
            document.getElementById('predictionPanel').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                if (!resJson.success) throw new Error(resJson.error);
                
                const data = resJson.data;
                if (data.length <= windowSize) {
                    statusEl.innerText = `ğŸš¨ éŒ¯èª¤ï¼šè³‡æ–™é‡ä¸è¶³ã€‚`;
                    return;
                }

                statusEl.innerText = `âœ… åŸ·è¡Œé›™æ ¸å¿ƒ O(N*W) çŸ©é™£é‹ç®—ä¸­...`;
                setTimeout(() => executeStrategies(data, windowSize, isBonusMode), 50);
                
            } catch (error) {
                statusEl.innerText = `ğŸš¨ éŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize, isBonusMode) {
            let labels = [];
            // Hit ç´€éŒ„
            let markovHitsData = [], streakHitsData = [], comboHitsData = [], randomHitsData = [];
            let hits = { markov: 0, streak: 0, combo: 0, random: 0 };
            
            // PnL ç´€éŒ„ (åˆå§‹è³‡é‡‘ 0)
            let markovPnlData = [], streakPnlData = [], comboPnlData = [], randomPnlData = [];
            let pnl = { markov: 0, streak: 0, combo: 0, random: 0 };
            const BET_COST = 25;
            
            for (let i = windowSize; i < data.length; i++) {
                const historyWindow = data.slice(i - windowSize, i); 
                const currentDraw = data[i-1].numbers; 
                const targetDraw = new Set(data[i].numbers); 
                labels.push(data[i].id);

                const mRank = getMarkovRank(historyWindow, currentDraw);
                const sRank = getStreakRank(historyWindow, currentDraw);
                const cRank = getEnsembleRank(mRank, sRank);
                
                const markovPred = mRank.slice(0, currentStarTarget);
                const streakPred = sRank.slice(0, currentStarTarget);
                const comboPred  = cRank.slice(0, 4); // ğŸŒŸ å…±æŒ¯é¤Šç‰Œæ°¸é å›ºå®š 4 æ˜Ÿ
                
                let randomPred = [];
                while(randomPred.length < currentStarTarget) {
                    let r = Math.floor(Math.random() * 80) + 1;
                    if(!randomPred.includes(r)) randomPred.push(r);
                }

                // è¨ˆç®—ç•¶æœŸå‘½ä¸­å¹¾é¡†çƒ
                let mHits = markovPred.filter(n => targetDraw.has(n)).length;
                let sHits = streakPred.filter(n => targetDraw.has(n)).length;
                let cHits = comboPred.filter(n => targetDraw.has(n)).length;
                let rHits = randomPred.filter(n => targetDraw.has(n)).length;

                // ç´¯åŠ ç¸½å‘½ä¸­çƒæ•¸
                hits.markov += mHits; hits.streak += sHits; hits.combo += cHits; hits.random += rHits;
                markovHitsData.push(hits.markov); streakHitsData.push(hits.streak); comboHitsData.push(hits.combo); randomHitsData.push(hits.random);

                // è¨ˆç®—è³‡é‡‘æç›Š = ç²å¾—çé‡‘ - æœ¬é‡‘(25å…ƒ)
                pnl.markov += getPayout(currentStarTarget, mHits, isBonusMode) - BET_COST;
                pnl.streak += getPayout(currentStarTarget, sHits, isBonusMode) - BET_COST;
                pnl.combo  += getPayout(4, cHits, isBonusMode) - BET_COST; // ğŸŒŸ æ°¸é ç”¨ 4æ˜Ÿè³ ç‡ç®—
                pnl.random += getPayout(currentStarTarget, rHits, isBonusMode) - BET_COST;

                markovPnlData.push(pnl.markov); streakPnlData.push(pnl.streak); comboPnlData.push(pnl.combo); randomPnlData.push(pnl.random);
            }

            // --- å¯¦æˆ°é æ¸¬æœ€æ–°ä¸€æœŸ ---
            const latestHistory = data.slice(data.length - windowSize);
            const absoluteCurrentDraw = data[data.length - 1].numbers; 
            
            const nextMarkov = getMarkovRank(latestHistory, absoluteCurrentDraw).slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextStreak = getStreakRank(latestHistory, absoluteCurrentDraw).slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextCombo  = getEnsembleRank(getMarkovRank(latestHistory, absoluteCurrentDraw), getStreakRank(latestHistory, absoluteCurrentDraw)).slice(0, 4).sort((a,b)=>a-b);

            document.getElementById('predMarkov').innerHTML = formatBalls(nextMarkov, 'ball-markov');
            document.getElementById('predStreak').innerHTML = formatBalls(nextStreak, 'ball-streak');
            document.getElementById('predCombo').innerHTML = formatBalls(nextCombo, 'ball-combo');
            generateRandom(); 
            document.getElementById('predictionPanel').style.display = 'block';

            // --- æ¸²æŸ“æ•¸æ“š ---
            const totalRounds = data.length - windowSize;
            const totalBallsPredicted = totalRounds * currentStarTarget; 
            
            document.getElementById('hitStats').innerHTML = `
                <div style="color: #f59e0b">æ‹–ç‰Œå‘½ä¸­ç‡: ${((hits.markov / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #06b6d4">é€£èŠå‘½ä¸­ç‡: ${((hits.streak / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #ec4899">4æ˜Ÿå…±æŒ¯å‘½ä¸­ç‡: ${((hits.combo / (totalRounds * 4))*100).toFixed(2)}%</div>
                <div style="color: var(--text-muted)">ççŒœå‘½ä¸­ç‡: ${((hits.random / totalBallsPredicted)*100).toFixed(2)}%</div>
            `;

            const formatPnL = (val) => `<span class="${val >= 0 ? 'pnl-positive' : 'pnl-negative'}">${val >= 0 ? '+NT$'+val : '-NT$'+Math.abs(val)}</span>`;

            document.getElementById('pnlStats').innerHTML = `
                <div style="color: #f59e0b">æ‹–ç‰Œç¸½æç›Š: ${formatPnL(pnl.markov)}</div>
                <div style="color: #06b6d4">é€£èŠç¸½æç›Š: ${formatPnL(pnl.streak)}</div>
                <div style="color: #ec4899">4æ˜Ÿå…±æŒ¯ç¸½æç›Š: ${formatPnL(pnl.combo)}</div>
                <div style="color: var(--text-muted)">ççŒœç¸½æç›Š: ${formatPnL(pnl.random)}</div>
            `;
            document.getElementById('status').innerText = "âœ… çŸ©é™£é‹ç®—èˆ‡æç›Šæ¨¡æ“¬å®Œæˆï¼";

            renderHitChart(labels, markovHitsData, streakHitsData, comboHitsData, randomHitsData);
            renderPnlChart(labels, markovPnlData, streakPnlData, comboPnlData, randomPnlData);
        }

        function renderHitChart(labels, mData, sData, cData, rData) {
            const ctx = document.getElementById('hitChart').getContext('2d');
            if (hitChartInstance) hitChartInstance.destroy();
            hitChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [
                    { label: `æ‹–ç‰Œ (${currentStarTarget}æ˜Ÿ)`, data: mData, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                    { label: `é€£èŠ (${currentStarTarget}æ˜Ÿ)`, data: sData, borderColor: '#06b6d4', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                    { label: `4æ˜Ÿå…±æŒ¯ (å›ºå®š)`, data: cData, borderColor: '#ec4899', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 3 },
                    { label: `ççŒœ`, data: rData, borderColor: '#475569', borderDash: [5, 5], backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 1 }
                ]},
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { x: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 15 } }, y: { display: true, ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#f8fafc' } } } }
            });
        }

        function renderPnlChart(labels, mData, sData, cData, rData) {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            if (pnlChartInstance) pnlChartInstance.destroy();
            pnlChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [
                    { label: `æ‹–ç‰Œ PnL`, data: mData, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 2 },
                    { label: `é€£èŠ PnL`, data: sData, borderColor: '#06b6d4', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 2 },
                    { label: `4æ˜Ÿå…±æŒ¯ PnL`, data: cData, borderColor: '#ec4899', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 3 },
                    { label: `ççŒœ PnL`, data: rData, borderColor: '#475569', borderDash: [5, 5], backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 1 }
                ]},
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { x: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 15 } }, y: { display: true, title: { display: true, text: 'æ·¨ç²åˆ© (NTD)', color: '#94a3b8' }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#f8fafc' } } } }
            });
        }
    </script>
</body>
</html>
