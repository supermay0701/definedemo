<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–ç­–ç•¥å›æ¸¬ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #2563eb; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #0f172a; color: white; width: 80px; }
        .stats { display: flex; gap: 20px; margin-top: 15px; font-size: 1.1em; }
        .hot { color: #ef4444; } .cold { color: #3b82f6; } .avg { color: #10b981; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Bingo ç­–ç•¥å›æ¸¬å¼•æ“ (Edge Compute)</h2>
        <div class="panel">
            <label>API æŠ“å–ç­†æ•¸: <input type="number" id="fetchLimit" value="200"></label>
            <label style="margin-left: 20px;">æ»‘å‹•çª—å£å¤§å° (æœŸ): <input type="number" id="windowSize" value="10"></label>
            <button style="margin-left: 20px;" onclick="runBacktest()">åŸ·è¡Œé‹ç®—èˆ‡å›æ¸¬</button>
            <p id="status" style="color: #94a3b8; font-size: 0.9em;">ç­‰å¾…æŒ‡ä»¤...</p>
        </div>
        
        <div class="panel">
            <canvas id="backtestChart" width="1000" height="400"></canvas>
            <div class="stats" id="finalStats"></div>
        </div>
    </div>

    <script>
        // æ›¿æ›ç‚ºä½ çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        let chartInstance = null;

        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const limit = document.getElementById('fetchLimit').value;
            const windowSize = parseInt(document.getElementById('windowSize').value);
            
            statusEl.innerText = "æ­£åœ¨å¾ Google Sheet æå–è³‡æ–™...";
            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                
                if (!resJson.success) throw new Error(resJson.error);
                const data = resJson.data;
                
                if (data.length <= windowSize) {
                    statusEl.innerText = "è³‡æ–™é‡ä¸è¶³ä»¥æ”¯æ’è©²çª—å£å¤§å°";
                    return;
                }

                statusEl.innerText = `æˆåŠŸè¼‰å…¥ ${data.length} ç­†è³‡æ–™ã€‚é–‹å§‹åŸ·è¡Œé‚Šç·£é‹ç®—...`;
                executeStrategies(data, windowSize);
                
            } catch (error) {
                statusEl.innerText = `éŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize) {
            let labels = [];
            let hotCumulativeHits = [];
            let coldCumulativeHits = [];
            let avgCumulativeHits = [];
            
            let hits = { hot: 0, cold: 0, avg: 0 };
            const TOTAL_NUMBERS = 80;
            const DRAW_COUNT = 20;
            
            // æ»‘å‹•çª—å£å›æ¸¬ (Sliding Window O(N) éæ­·)
            for (let i = windowSize; i < data.length; i++) {
                // æ“·å–éå» windowSize æœŸçš„è³‡æ–™ä½œç‚ºè§€å¯Ÿæ¨£æœ¬
                const historyWindow = data.slice(i - windowSize, i);
                const targetDraw = new Set(data[i].numbers); // æœ¬æœŸå¯¦éš›é–‹çè™Ÿç¢¼
                labels.push(data[i].id);

                // è¨ˆç®—æ­·å²é »æ¬¡
                let freqMap = {};
                for (let n = 1; n <= TOTAL_NUMBERS; n++) freqMap[n] = 0;
                
                historyWindow.forEach(row => {
                    row.numbers.forEach(num => {
                        if (freqMap[num] !== undefined) freqMap[num]++;
                    });
                });

                // ç­–ç•¥ 1: å‹•é‡ (ç†±è™Ÿ Top 5)
                const hotPred = Object.keys(freqMap)
                    .sort((a, b) => freqMap[b] - freqMap[a])
                    .slice(0, 5).map(Number);
                
                // ç­–ç•¥ 2: å‡å€¼å›æ­¸ (å†·è™Ÿ Bottom 5ï¼Œæ’é™¤0æ¬¡)
                const expectedCount = windowSize * (DRAW_COUNT / TOTAL_NUMBERS);
                const coldPred = Object.keys(freqMap)
                    .filter(k => freqMap[k] > 0 && freqMap[k] < expectedCount * 0.8)
                    .sort((a, b) => freqMap[a] - freqMap[b])
                    .slice(0, 5).map(Number);
                
                // ç­–ç•¥ 3: å¤§æ•¸æ³•å‰‡ (æœ€è²¼è¿‘æœŸæœ›å€¼ Top 5)
                const avgPred = Object.keys(freqMap)
                    .sort((a, b) => Math.abs(freqMap[a] - expectedCount) - Math.abs(freqMap[b] - expectedCount))
                    .slice(0, 5).map(Number);

                // è¨ˆç®—å‘½ä¸­æ•¸ä¸¦ç´¯åŠ 
                hits.hot += hotPred.filter(n => targetDraw.has(n)).length;
                hits.cold += coldPred.filter(n => targetDraw.has(n)).length;
                hits.avg += avgPred.filter(n => targetDraw.has(n)).length;

                hotCumulativeHits.push(hits.hot);
                coldCumulativeHits.push(hits.cold);
                avgCumulativeHits.push(hits.avg);
            }

            // æ›´æ–° UI çµ±è¨ˆ
            const totalPredictions = (data.length - windowSize) * 5; // æ¯æ¬¡é æ¸¬5å€‹è™Ÿç¢¼
            document.getElementById('finalStats').innerHTML = `
                <span class="hot">ğŸ”¥ å‹•é‡(ç†±) å‘½ä¸­ç‡: ${((hits.hot / totalPredictions)*100).toFixed(2)}% (${hits.hot}/${totalPredictions})</span>
                <span class="cold">â„ï¸ å‡å€¼(å†·) å‘½ä¸­ç‡: ${((hits.cold / totalPredictions)*100).toFixed(2)}% (${hits.cold}/${totalPredictions})</span>
                <span class="avg">âš–ï¸ å¤§æ•¸(å¹³å‡) å‘½ä¸­ç‡: ${((hits.avg / totalPredictions)*100).toFixed(2)}% (${hits.avg}/${totalPredictions})</span>
            `;
            document.getElementById('status').innerText = "å›æ¸¬å®Œæˆ";

            renderChart(labels, hotCumulativeHits, coldCumulativeHits, avgCumulativeHits);
        }

        function renderChart(labels, hotData, coldData, avgData) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ğŸ”¥ å‹•é‡ç­–ç•¥ç´¯ç©å‘½ä¸­', data: hotData, borderColor: '#ef4444', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0 },
                        { label: 'â„ï¸ å‡å€¼å›æ­¸ç´¯ç©å‘½ä¸­', data: coldData, borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0 },
                        { label: 'âš–ï¸ å¤§æ•¸æ³•å‰‡ç´¯ç©å‘½ä¸­', data: avgData, borderColor: '#10b981', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: true, title: { display: true, text: 'æœŸæ•¸ (æ™‚é–“æ¨é€²)', color: '#94a3b8' }, ticks: { color: '#94a3b8' } },
                        y: { display: true, title: { display: true, text: 'ç´¯ç©å‘½ä¸­çƒæ•¸', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#f8fafc' } } }
                }
            });
        }
    </script>
</body>
</html>
