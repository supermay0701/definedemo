<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–èˆ‡è³‡ç”¢é…ç½®ç³»çµ± 7.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --text: #f8fafc; --text-muted: #94a3b8; --accent: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; position: relative; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* æ§åˆ¶é¢æ¿å€ */
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .control-item { display: flex; align-items: center; background: #0f172a; padding: 5px 10px; border-radius: 8px; border: 1px solid #334155;}
        input[type="number"], select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: white; font-size: 15px; text-align: center; margin: 0 8px;}
        button { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button.btn-fun { background: #8b5cf6; background-image: linear-gradient(to right, #8b5cf6, #d946ef); width: 100%; margin-top: 10px; padding: 8px;}
        button.btn-fun:hover { background-image: linear-gradient(to right, #7c3aed, #c026d3); }
        
        /* é ç±¤è¨­è¨ˆ */
        .tabs { display: flex; gap: 10px; margin-bottom: -1px; }
        .tab-btn { background: var(--panel); color: var(--text-muted); border: 1px solid var(--border); border-bottom: none; padding: 12px 24px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; box-shadow: none; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tab-content { display: none; background: var(--panel); padding: 20px; border-radius: 0 8px 8px 8px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
        .tab-content.active { display: block; }

        /* é æ¸¬å¡ç‰‡å€ */
        .prediction-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .pred-card { background: var(--bg); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column;}
        .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card-markov::before { background: #f59e0b; } .card-streak::before { background: #06b6d4; } .card-combo::before { background: #ec4899; } .card-random::before { background: #10b981; }
        .pred-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; justify-content: center;}
        .desc { font-size: 0.8em; color: var(--text-muted); margin-bottom: 10px; min-height: 35px; line-height: 1.4;}
        .pred-numbers { min-height: 45px; display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; flex-grow: 1; align-items: center;}
        
        /* çƒé«”è¨­è¨ˆ */
        .ball { display: flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; font-weight: bold; font-size: 16px; color: #1e293b; box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), inset 2px 2px 6px rgba(255,255,255,0.8); animation: popIn 0.3s ease-out forwards; }
        .ball-markov { background: radial-gradient(circle at 30% 30%, #fcd34d, #f59e0b); }
        .ball-streak { background: radial-gradient(circle at 30% 30%, #67e8f9, #06b6d4); }
        .ball-combo { background: radial-gradient(circle at 30% 30%, #f472b6, #ec4899); color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.5); }
        .ball-random { background: radial-gradient(circle at 30% 30%, #6ee7b7, #10b981); }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        /* çµ±è¨ˆå€ */
        .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 1em; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px;}
        .pnl-positive { color: #10b981; font-weight: bold; }
        .pnl-negative { color: #ef4444; font-weight: bold; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; margin: 0 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ec4899; box-shadow: 0 0 10px #ec4899; }
        input:checked + .slider:before { transform: translateX(20px); }

        #version-badge { position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.8); color: var(--text-muted); padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 0.85em; border: 1px solid var(--border); }

        /* æŠ•è³‡å„€è¡¨æ¿ */
        .invest-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .invest-card { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
        .invest-card .invest-label { font-size: 0.8em; color: var(--text-muted); margin-bottom: 5px; }
        .invest-card .invest-value { font-size: 1.3em; font-weight: bold; }
        /* ç­–ç•¥å°æ¯”è¡¨ */
        .strategy-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .strategy-table th, .strategy-table td { padding: 10px 12px; text-align: center; border-bottom: 1px solid var(--border); }
        .strategy-table th { background: var(--bg); color: var(--text-muted); font-weight: bold; font-size: 0.85em; }
        .strategy-table tr:hover { background: rgba(59, 130, 246, 0.1); }
        /* äº‚æ•¸ççŒœç¨ç«‹å€ */
        .random-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
        .random-group { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .random-group-label { font-size: 0.85em; color: var(--text-muted); min-width: 50px; font-weight: bold; }
        .random-group .pred-numbers { display: flex; flex-wrap: wrap; gap: 6px; }
    </style>
</head>
<body>
    <div id="version-badge">Loading version...</div>

    <div class="container">
        <h2>Bingo çŸ©é™£é‡åŒ–èˆ‡æŠ•è³‡çµ„åˆå¼•æ“ </h2>
        
        <div class="panel controls">
            <div class="control-item">
                <label>è¿‘</label> <input type="number" id="fetchDays" value="5" style="width: 50px;"> <label>å¤©è³‡æ–™</label>
            </div>
            <div class="control-item">
                <label>çª—å£:</label> <input type="number" id="windowSize" value="200" style="width: 60px;"> <label>æœŸ</label>
            </div>
            <div class="control-item">
                <label>æ˜Ÿæ•¸:</label> 
                <select id="starSelect">
                    <option value="1">1 æ˜Ÿ</option><option value="2">2 æ˜Ÿ</option><option value="3">3 æ˜Ÿ</option>
                    <option value="4" selected>4 æ˜Ÿ</option><option value="5">5 æ˜Ÿ</option><option value="6">6 æ˜Ÿ</option>
                    <option value="7">7 æ˜Ÿ</option><option value="8">8 æ˜Ÿ</option><option value="9">9 æ˜Ÿ</option><option value="10">10 æ˜Ÿ</option>
                </select>
            </div>
            <div class="control-item" style="border-color: #ec4899;">
                <label style="color: #ec4899; font-weight: bold;">ğŸ çé‡‘åŠ å€æ¨¡å¼</label>
                <label class="switch">
                    <input type="checkbox" id="bonusToggle">
                    <span class="slider"></span>
                </label>
            </div>

            <button onclick="runBacktest()">ğŸš€ åŸ·è¡Œæ·±åº¦å›æ¸¬</button>
        </div>
        <p id="status" style="color: var(--text-muted); margin: -10px 0 15px 5px; font-size: 0.9em;">ç³»çµ±é–’ç½®ä¸­...</p>
        
        <div class="panel" id="predictionPanel" style="display: none; padding-top: 15px;">
            <h3 style="margin-top: 0; color: #f8fafc; border-bottom: 1px solid #334155; padding-bottom: 10px; font-size: 1.1em;">ğŸ¯ æ¬¡æœŸå¯¦æˆ°æŠ•è³‡çµ„åˆ (æ ¹æ“šæœ€æ–°ä¸€æœŸæ¢ä»¶æ¨ç®—)</h3>
            <div class="prediction-box" id="predictionCards">
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-hitrate')">ğŸ¯ æ­·å²å‘½ä¸­ç‡</button>
            <button class="tab-btn" onclick="switchTab('tab-pnl')">ğŸ’° æŠ•è³‡ç­–ç•¥æç›Š</button>
            <button class="tab-btn" onclick="switchTab('tab-random')">ğŸ² äº‚æ•¸ççŒœ</button>
        </div>

        <div id="tab-hitrate" class="tab-content active">
            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*é»æ“Šåœ–ä¾‹åç¨±å¯é¡¯ç¤º/éš±è—ç­–ç•¥ã€‚æ–œç‡è¶Šé™¡=å‘½ä¸­ç‡è¶Šé«˜ã€‚è‹¥è¢«è™›ç·š(ğŸ²äº‚æ•¸)çºä½ï¼Œä»£è¡¨ç­–ç•¥ç„¡æ•ˆã€‚</p>
            <canvas id="hitChart" width="1000" height="350"></canvas>
            <div class="stats" id="hitStats"></div>
        </div>

        <div id="tab-pnl" class="tab-content">
            <div class="invest-dashboard">
                <div class="invest-card">
                    <div class="invest-label">ğŸ“Š å›æ¸¬æœŸæ•¸</div>
                    <div class="invest-value" id="pnlRounds">-</div>
                </div>
                <div class="invest-card">
                    <div class="invest-label">ğŸ’¸ å–®æ³¨æˆæœ¬</div>
                    <div class="invest-value">NT$25</div>
                </div>
                <div class="invest-card">
                    <div class="invest-label">â­ æŠ•æ³¨æ˜Ÿæ•¸</div>
                    <div class="invest-value" id="pnlStars">-</div>
                </div>
                <div class="invest-card">
                    <div class="invest-label">ğŸ åŠ å€æ¨¡å¼</div>
                    <div class="invest-value" id="pnlBonus">-</div>
                </div>
            </div>

            <div style="overflow-x: auto; margin-bottom: 15px;">
                <table class="strategy-table">
                    <thead>
                        <tr>
                            <th>ç­–ç•¥</th>
                            <th>ç¸½æŠ•å…¥</th>
                            <th>ç¸½çé‡‘</th>
                            <th>æ·¨æç›Š</th>
                            <th>ROI</th>
                            <th>å‹ç‡</th>
                            <th>æœ€å¤§å›æ’¤</th>
                            <th>æœ€å¤§é€£æ•—</th>
                        </tr>
                    </thead>
                    <tbody id="strategyTableBody">
                        <tr><td colspan="8" style="text-align:center; color: var(--text-muted);">å°šæœªåŸ·è¡Œå›æ¸¬...</td></tr>
                    </tbody>
                </table>
            </div>

            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; color: var(--accent); font-weight: bold;">ğŸ“‹ ç•¶å‰æ˜Ÿæ•¸è³ ç‡å°ç…§è¡¨</summary>
                <div id="payoutRef" style="margin-top: 10px; overflow-x: auto;"></div>
            </details>

            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*é»æ“Šåœ–ä¾‹åç¨±å¯é¡¯ç¤º/éš±è—ç­–ç•¥ã€‚åˆå§‹è³‡é‡‘ 0 å…ƒï¼Œæ–œç‡å¾€ä¸‹=è™§æã€‚é è¨­é¡¯ç¤ºæ ¸å¿ƒç­–ç•¥ï¼Œé»æ“Šåœ–ä¾‹é–‹å•Ÿå¯¦é©—ç­–ç•¥ã€‚</p>
            <canvas id="pnlChart" width="1000" height="350"></canvas>
        </div>

        <div id="tab-random" class="tab-content">
            <p style="color: var(--text-muted); margin-top: 0; font-size: 0.9em;">ğŸ² ç´”ç²¹éš¨æ©Ÿç”¢ç”Ÿè™Ÿç¢¼ï¼Œä¸éœ€è¦æ­·å²è³‡æ–™ã€‚æ‰“ç ´äººè…¦é¸è™Ÿåè¦‹ï¼Œåæ­£éƒ½æ˜¯è² æœŸæœ›å€¼ï¼Œä¸å¦‚æ“²éª°å­ï¼</p>
            <div class="random-controls">
                <div class="control-item">
                    <label>æ˜Ÿæ•¸ï¼š</label>
                    <select id="randomStarSelect">
                        <option value="1">1 æ˜Ÿ</option><option value="2">2 æ˜Ÿ</option><option value="3">3 æ˜Ÿ</option>
                        <option value="4" selected>4 æ˜Ÿ</option><option value="5">5 æ˜Ÿ</option><option value="6">6 æ˜Ÿ</option>
                        <option value="7">7 æ˜Ÿ</option><option value="8">8 æ˜Ÿ</option><option value="9">9 æ˜Ÿ</option><option value="10">10 æ˜Ÿ</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>çµ„æ•¸ï¼š</label>
                    <input type="number" id="randomGroupCount" value="5" min="1" max="20" style="width: 50px;">
                </div>
                <button onclick="generateRandomTab()" style="background-image: linear-gradient(to right, #10b981, #06b6d4);">ğŸ² å‘½é‹åç¸®ï¼</button>
            </div>
            <div id="randomResults"></div>
        </div>

    </div>

    <script>
        // ============================================
        // ğŸš¨ é€™è£¡å¿…é ˆæ‰‹å‹•æ›¿æ›ç‚ºä½ æœ€æ–°çš„ GAS Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        const APP_VERSION = "v7.0.0 (PnL Pro Edition)"; 
        // ============================================

        document.getElementById('version-badge').innerText = APP_VERSION;
        let hitChartInstance = null;
        let pnlChartInstance = null;
        let currentStarTarget = 4;

        // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function formatBalls(arr, styleClass) {
            return arr.map(num => `<div class="ball ${styleClass}">${num < 10 ? '0'+num : num}</div>`).join('');
        }

        // --- å°å½©æ¨™æº–è³ ç‡è¡¨ (æ¯æ³¨ 25 å…ƒ) ---
        // æ ¼å¼: standardPayout[æ˜Ÿæ•¸][çŒœä¸­çƒæ•¸] = çé‡‘ (æ–°å°å¹£)
        const standardPayout = {
            1: { 1: 50, 0: 0 },
            2: { 2: 75, 1: 0, 0: 0 },
            3: { 3: 500, 2: 50, 1: 0, 0: 0 },
            4: { 4: 1000, 3: 100, 2: 25, 1: 0, 0: 0 },
            5: { 5: 7500, 4: 500, 3: 50, 2: 0, 1: 0, 0: 0 },
            6: { 6: 25000, 5: 1000, 4: 200, 3: 25, 2: 0, 1: 0, 0: 0 },
            7: { 7: 80000, 6: 3000, 5: 300, 4: 50, 3: 25, 2: 0, 1: 0, 0: 0 },
            8: { 8: 500000, 7: 20000, 6: 1000, 5: 200, 4: 25, 3: 0, 2: 0, 1: 0, 0: 25 },
            9: { 9: 1000000, 8: 100000, 7: 3000, 6: 500, 5: 100, 4: 25, 3: 0, 2: 0, 1: 0, 0: 25 },
            10: { 10: 5000000, 9: 250000, 8: 25000, 7: 2500, 6: 250, 5: 25, 4: 0, 3: 0, 2: 0, 1: 0, 0: 25 }
        };

        // --- å°å½©åŠ å€æ´»å‹•è³ ç‡è¡¨ (å‹•æ…‹è¦†å¯«ç‰ˆ) ---
        // å…ˆæ·±æ‹·è²(è¤‡è£½)ä¸€ä»½æ¨™æº–è³ ç‡ï¼Œé€™æ¨£æ²’è¢«åŠ ç¢¼çš„çé …(å¦‚4æ˜Ÿä¸­2)æ‰ä¸æœƒè®Šæˆ0å…ƒ
        const bonusPayout = JSON.parse(JSON.stringify(standardPayout)); 
        
        // ä¾ç…§ä½¿ç”¨è€…æä¾›çš„ã€ŒåŠ ç¢¼æœŸé–“çé‡‘å°ç…§è¡¨ã€ç²¾æº–è¦†å¯«
        bonusPayout[1][1] = 75;     // 1æ˜Ÿä¸­1: 50 -> 75
        
        bonusPayout[2][2] = 150;    // 2æ˜Ÿä¸­2: 75 -> 150
        
        bonusPayout[3][3] = 1000;   // 3æ˜Ÿä¸­3: 500 -> 1000
        
        bonusPayout[4][4] = 2000;   // 4æ˜Ÿä¸­4: 1000 -> 2000
        bonusPayout[4][3] = 150;    // 4æ˜Ÿä¸­3: 100 -> 150
        
        bonusPayout[5][5] = 10000;  // 5æ˜Ÿä¸­5: 7500 -> 10000
        bonusPayout[5][4] = 600;    // 5æ˜Ÿä¸­4: 500 -> 600
        
        bonusPayout[6][6] = 50000;  // 6æ˜Ÿä¸­6: 25000 -> 50000
        bonusPayout[6][5] = 1200;   // 6æ˜Ÿä¸­5: 1000 -> 1200

        // æ ¸å¿ƒè¨ˆç®—å¼•æ“ï¼šæ ¹æ“šæœ‰ç„¡æ‰“é–‹ã€ŒåŠ å€é–‹é—œã€ï¼Œçµ¦å‡ºå°æ‡‰çé‡‘
        function getPayout(star, hits, isBonusMode) {
            const table = isBonusMode ? bonusPayout : standardPayout;
            if (table[star] && table[star][hits] !== undefined) {
                return table[star][hits];
            }
            return 0; // æ²’ä¸­ç
        }

        // --- æ ¸å¿ƒæ¼”ç®—æ³•åº« (åŒä¸Š) ---
        function getMarkovRank(history, currentDraw) {
            let nextCounts = new Array(81).fill(0);
            for (let i = 0; i < history.length - 1; i++) {
                let prev = history[i].numbers;
                let next = history[i+1].numbers;
                let matchWeight = currentDraw.filter(n => prev.includes(n)).length;
                if (matchWeight > 0) next.forEach(num => nextCounts[num] += matchWeight);
            }
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => nextCounts[b] - nextCounts[a]);
        }

        function getStreakRank(history, currentDraw) {
            let survivalRates = {};
            for (let n = 1; n <= 80; n++) {
                let appearCount = 0; let survivedCount = 0;
                for (let i = 0; i < history.length - 1; i++) {
                    if (history[i].numbers.includes(n)) {
                        appearCount++;
                        if (history[i+1].numbers.includes(n)) survivedCount++;
                    }
                }
                let baseRate = appearCount > 0 ? (survivedCount / appearCount) : 0;
                survivalRates[n] = currentDraw.includes(n) ? baseRate * 1.5 : baseRate * 0.5; 
            }
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => survivalRates[b] - survivalRates[a]);
        }

        function getEnsembleRank(markovRank, streakRank) {
            let combinedScores = {};
            for (let i = 1; i <= 80; i++) combinedScores[i] = markovRank.indexOf(i) + streakRank.indexOf(i);
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => combinedScores[a] - combinedScores[b]);
        }

        function generateRandomNums(count) {
            let nums = [];
            while(nums.length < count) {
                let r = Math.floor(Math.random() * 80) + 1;
                if(!nums.includes(r)) nums.push(r);
            }
            return nums.sort((a, b) => a - b);
        }

        function generateRandomTab() {
            const star = parseInt(document.getElementById('randomStarSelect').value);
            const groups = parseInt(document.getElementById('randomGroupCount').value) || 1;
            let html = '';
            for (let g = 0; g < groups; g++) {
                const nums = generateRandomNums(star);
                html += `<div class="random-group">
                    <span class="random-group-label">ç¬¬ ${g+1} çµ„</span>
                    <div class="pred-numbers">${formatBalls(nums, 'ball-random')}</div>
                </div>`;
            }
            document.getElementById('randomResults').innerHTML = html;
        }

        function renderPayoutTable(star, isBonusMode) {
            const table = isBonusMode ? bonusPayout : standardPayout;
            const payouts = table[star];
            if (!payouts) return;
            let html = '<table class="strategy-table"><thead><tr><th>çŒœä¸­çƒæ•¸</th><th>çé‡‘ (NT$)</th><th>æ·¨ç²åˆ©</th></tr></thead><tbody>';
            for (let i = star; i >= 0; i--) {
                const prize = payouts[i] || 0;
                const net = prize - 25;
                html += `<tr><td>${i} / ${star}</td><td>NT$${prize.toLocaleString()}</td><td class="${net >= 0 ? 'pnl-positive' : 'pnl-negative'}">${net >= 0 ? '+' : ''}NT$${net.toLocaleString()}</td></tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('payoutRef').innerHTML = html;
        }

        // --- æ–°å¢ç­–ç•¥æ¼”ç®—æ³•åº« ---
        function getHotRank(history) {
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => freq[b] - freq[a]);
        }

        function getColdRank(history) {
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => freq[a] - freq[b]);
        }

        function getOverdueRank(history) {
            let lastSeen = {};
            for (let n = 1; n <= 80; n++) lastSeen[n] = -1;
            history.forEach((draw, idx) => draw.numbers.forEach(n => lastSeen[n] = idx));
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => lastSeen[a] - lastSeen[b]);
        }

        function getPrimeRank(history) {
            function isPrime(n) { if (n < 2) return false; for (let d = 2; d * d <= n; d++) if (n % d === 0) return false; return true; }
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            const primes = Array.from({length: 80}, (_, i) => i + 1).filter(isPrime);
            const nonPrimes = Array.from({length: 80}, (_, i) => i + 1).filter(n => !isPrime(n));
            return [...primes.sort((a, b) => freq[b] - freq[a]), ...nonPrimes.sort((a, b) => freq[b] - freq[a])];
        }

        function getFibonacciRank(history) {
            const fibs = new Set();
            let a = 1, b = 1;
            while (a <= 80) { fibs.add(a); let t = a + b; a = b; b = t; }
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            const fibNums = Array.from({length: 80}, (_, i) => i + 1).filter(n => fibs.has(n));
            const nonFibNums = Array.from({length: 80}, (_, i) => i + 1).filter(n => !fibs.has(n));
            return [...fibNums.sort((a, b) => freq[b] - freq[a]), ...nonFibNums.sort((a, b) => freq[b] - freq[a])];
        }

        function getTailDigitRank(history) {
            const recent = history.slice(-20);
            let digitFreq = new Array(10).fill(0);
            recent.forEach(draw => draw.numbers.forEach(n => digitFreq[n % 10]++));
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => {
                const dDiff = digitFreq[b % 10] - digitFreq[a % 10];
                return dDiff !== 0 ? dDiff : freq[b] - freq[a];
            });
        }

        function getDragonTigerRank(history) {
            const recent = history.slice(-10);
            let highCount = 0, lowCount = 0;
            recent.forEach(draw => draw.numbers.forEach(n => n <= 40 ? lowCount++ : highCount++));
            let freq = new Array(81).fill(0);
            history.forEach(draw => draw.numbers.forEach(n => freq[n]++));
            const betHigh = lowCount > highCount;
            return Array.from({length: 80}, (_, i) => i + 1).sort((a, b) => {
                const aP = betHigh ? a > 40 : a <= 40;
                const bP = betHigh ? b > 40 : b <= 40;
                if (aP && !bP) return -1;
                if (!aP && bP) return 1;
                return freq[b] - freq[a];
            });
        }

        // --- ç­–ç•¥è¨»å†Šè¡¨ ---
        const STRATEGIES = [
            { id: 'markov', name: 'ğŸ”— æ‹–ç‰Œæ©Ÿç‡', color: '#f59e0b', light: '#fcd34d',
              desc: 'é¦¬å¯å¤«éˆï¼šæ­·å²æœ€å¸¸ç·Šè·Ÿç•¶å‰è™Ÿç¢¼é–‹å‡ºçš„çƒ', predict: (h,c) => getMarkovRank(h,c) },
            { id: 'streak', name: 'ğŸ§² é€£èŠå‹•èƒ½', color: '#06b6d4', light: '#67e8f9',
              desc: 'é€£èŠå­˜æ´»ç‡ï¼šå‰›é–‹å‡ºçš„è™Ÿç¢¼ä¸­ï¼Œæ­·å²å­˜æ´»ç‡æœ€é«˜', predict: (h,c) => getStreakRank(h,c) },
            { id: 'combo', name: 'ğŸŒŸ 4æ˜Ÿå…±æŒ¯', color: '#ec4899', light: '#f472b6', fixedStar: 4, textColor: 'white',
              desc: 'æ‹–ç‰Œ+é€£èŠç¶œåˆæ’åï¼Œå¼·åˆ¶4æ˜Ÿé˜²ç¦¦çµ„åˆ', predict: (h,c) => getEnsembleRank(getMarkovRank(h,c), getStreakRank(h,c)) },
            { id: 'hot', name: 'ğŸ”¥ ç†±è™Ÿè¿½æ“Š', color: '#ef4444', light: '#fca5a5',
              desc: 'è¿½æ¼²ï¼šé¸è¦–çª—å…§å‡ºç¾é »ç‡æœ€é«˜çš„è™Ÿç¢¼', predict: (h,c) => getHotRank(h) },
            { id: 'cold', name: 'â„ï¸ å†·è™ŸæŠ„åº•', color: '#60a5fa', light: '#bfdbfe',
              desc: 'æŠ„åº•ï¼šé¸è¦–çª—å…§æœ€å°‘å‡ºç¾çš„è™Ÿç¢¼ï¼Œé€†å‹¢æ“ä½œ', predict: (h,c) => getColdRank(h) },
            { id: 'overdue', name: 'â° éºæ¼åå½ˆ', color: '#a78bfa', light: '#c4b5fd',
              desc: 'å‡å€¼å›æ­¸ï¼šé¸é€£çºŒæœ€å¤šæœŸæœªå‡ºç¾çš„è™Ÿç¢¼', predict: (h,c) => getOverdueRank(h) },
            { id: 'antiMarkov', name: 'ğŸš« é€†å‘æ€ç¶­', color: '#f472b6', light: '#fbcfe8',
              desc: 'åæŒ‡æ¨™ï¼šé¸é¦¬å¯å¤«éˆæœ€ä¸çœ‹å¥½çš„è™Ÿç¢¼', predict: (h,c) => getMarkovRank(h,c).reverse() },
            { id: 'prime', name: 'ğŸ§® è³ªæ•¸ä¿¡ä»°', color: '#34d399', light: '#6ee7b7',
              desc: 'æ•¸å­¸æµªæ¼«ï¼šåªå¾è³ªæ•¸ä¸­é¸ï¼ŒæŒ‰å‡ºç¾é »ç‡æ’åº', predict: (h,c) => getPrimeRank(h) },
            { id: 'fibonacci', name: 'ğŸŒ€ è²»æ°æ•¸åˆ—', color: '#fbbf24', light: '#fde68a',
              desc: 'è‡ªç„¶æ³•å‰‡ï¼šåªå¾è²»æ³¢é‚£å¥‘æ•¸(1,2,3,5,8,13,21,34,55)ä¸­é¸', predict: (h,c) => getFibonacciRank(h) },
            { id: 'tailDigit', name: 'ğŸ“Š å°¾æ•¸è¶¨å‹¢', color: '#2dd4bf', light: '#99f6e4',
              desc: 'è¶¨å‹¢è·Ÿè¹¤ï¼šè¿½è¹¤è¿‘20æœŸå“ªå€‹å°¾æ•¸(å€‹ä½æ•¸)æœ€ç†±é–€', predict: (h,c) => getTailDigitRank(h) },
            { id: 'dragonTiger', name: 'ğŸ‰ é¾è™ç¿»è½‰', color: '#fb923c', light: '#fed7aa',
              desc: 'å¤§å°å‡å€¼å›æ­¸ï¼šè¿‘10æœŸé«˜è™Ÿå¤šâ†’æŠ¼ä½è™Ÿï¼Œåä¹‹äº¦ç„¶', predict: (h,c) => getDragonTigerRank(h) },
            { id: 'random', name: 'ğŸ² äº‚æ•¸åŸºæº–', color: '#475569', light: '#94a3b8', isRandom: true,
              desc: 'ç´”éš¨æ©Ÿå°ç…§åŸºæº–ç·š',
              predict: () => { let r=[]; while(r.length<80){let n=Math.floor(Math.random()*80)+1; if(!r.includes(n))r.push(n);} return r; } }
        ];

        // --- ä¸»æµç¨‹èˆ‡å›æ¸¬ ---
        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const days = parseInt(document.getElementById('fetchDays').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);
            currentStarTarget = parseInt(document.getElementById('starSelect').value);
            const isBonusMode = document.getElementById('bonusToggle').checked;
            
            const limit = days * 205; 
            statusEl.innerText = `â³ æå–é›²ç«¯æ•¸æ“šä¸­...`;
            document.getElementById('predictionPanel').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                if (!resJson.success) throw new Error(resJson.error);
                
                const data = resJson.data;
                if (data.length <= windowSize) {
                    statusEl.innerText = `ğŸš¨ éŒ¯èª¤ï¼šè³‡æ–™é‡ä¸è¶³ã€‚`;
                    return;
                }

                statusEl.innerText = `âœ… åŸ·è¡Œé›™æ ¸å¿ƒ O(N*W) çŸ©é™£é‹ç®—ä¸­...`;
                setTimeout(() => executeStrategies(data, windowSize, isBonusMode), 50);
                
            } catch (error) {
                statusEl.innerText = `ğŸš¨ éŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize, isBonusMode) {
            let labels = [];
            const BET_COST = 25;
            
            // å‹•æ…‹åˆå§‹åŒ–æ‰€æœ‰ç­–ç•¥è¿½è¹¤å™¨
            let trackers = {};
            STRATEGIES.forEach(s => {
                trackers[s.id] = {
                    hitsData: [], pnlData: [], hits: 0, pnl: 0,
                    winCount: 0, grossReturns: 0, peakPnl: 0, maxDrawdown: 0,
                    consecutiveLoss: 0, maxConsecutiveLoss: 0
                };
            });
            
            for (let i = windowSize; i < data.length; i++) {
                const historyWindow = data.slice(i - windowSize, i); 
                const currentDraw = data[i-1].numbers; 
                const targetDraw = new Set(data[i].numbers); 
                labels.push(data[i].id);

                STRATEGIES.forEach(s => {
                    const starCount = s.fixedStar || currentStarTarget;
                    const pred = s.predict(historyWindow, currentDraw).slice(0, starCount);
                    const hitCount = pred.filter(n => targetDraw.has(n)).length;
                    const t = trackers[s.id];
                    
                    t.hits += hitCount;
                    t.hitsData.push(t.hits);
                    
                    const reward = getPayout(starCount, hitCount, isBonusMode);
                    t.grossReturns += reward;
                    if (reward > BET_COST) t.winCount++;
                    t.pnl += reward - BET_COST;
                    t.peakPnl = Math.max(t.peakPnl, t.pnl);
                    t.maxDrawdown = Math.max(t.maxDrawdown, t.peakPnl - t.pnl);
                    if (reward < BET_COST) { t.consecutiveLoss++; t.maxConsecutiveLoss = Math.max(t.maxConsecutiveLoss, t.consecutiveLoss); }
                    else { t.consecutiveLoss = 0; }
                    t.pnlData.push(t.pnl);
                });
            }

            // --- å¯¦æˆ°é æ¸¬æœ€æ–°ä¸€æœŸ (æ‰€æœ‰ç­–ç•¥) ---
            const latestHistory = data.slice(data.length - windowSize);
            const absoluteCurrentDraw = data[data.length - 1].numbers; 
            
            let predHTML = '';
            STRATEGIES.filter(s => !s.isRandom).forEach(s => {
                const starCount = s.fixedStar || currentStarTarget;
                const pred = s.predict(latestHistory, absoluteCurrentDraw).slice(0, starCount).sort((a,b) => a-b);
                const tc = s.textColor || '#1e293b';
                predHTML += `<div class="pred-card" style="border-top: 4px solid ${s.color};">
                    <div class="pred-title" style="color: ${s.color};">${s.name}</div>
                    <div class="desc">${s.desc}</div>
                    <div class="pred-numbers">${pred.map(n => `<div class="ball" style="background:radial-gradient(circle at 30% 30%,${s.light},${s.color});color:${tc};">${n<10?'0'+n:n}</div>`).join('')}</div>
                </div>`;
            });
            document.getElementById('predictionCards').innerHTML = predHTML;
            document.getElementById('predictionPanel').style.display = 'block';

            // --- æ¸²æŸ“æ•¸æ“š ---
            const totalRounds = data.length - windowSize;
            
            // å‘½ä¸­ç‡çµ±è¨ˆ
            let hitStatsHTML = '';
            STRATEGIES.forEach(s => {
                const t = trackers[s.id];
                const balls = totalRounds * (s.fixedStar || currentStarTarget);
                hitStatsHTML += `<div style="color:${s.color}">${s.name}: ${((t.hits/balls)*100).toFixed(2)}%</div>`;
            });
            document.getElementById('hitStats').innerHTML = hitStatsHTML;

            // PnL å„€è¡¨æ¿
            const formatPnL = (val) => `<span class="${val >= 0 ? 'pnl-positive' : 'pnl-negative'}">${val >= 0 ? '+NT$'+val.toLocaleString() : '-NT$'+Math.abs(val).toLocaleString()}</span>`;
            const formatPct = (val) => `<span class="${val >= 0 ? 'pnl-positive' : 'pnl-negative'}">${val >= 0 ? '+' : ''}${val.toFixed(1)}%</span>`;
            
            document.getElementById('pnlRounds').innerText = totalRounds + ' æœŸ';
            document.getElementById('pnlStars').innerText = currentStarTarget + ' æ˜Ÿ';
            document.getElementById('pnlBonus').innerHTML = isBonusMode ? '<span style="color:#ec4899">ON</span>' : '<span style="color:var(--text-muted)">OFF</span>';
            
            const totalInvested = totalRounds * BET_COST;
            let tableHTML = '';
            STRATEGIES.forEach(s => {
                const t = trackers[s.id];
                const roi = (t.pnl / totalInvested) * 100;
                const winRate = (t.winCount / totalRounds) * 100;
                tableHTML += `<tr>
                    <td style="color:${s.color}; font-weight:bold; text-align:left;">${s.name}</td>
                    <td>NT$${totalInvested.toLocaleString()}</td>
                    <td>NT$${t.grossReturns.toLocaleString()}</td>
                    <td>${formatPnL(t.pnl)}</td>
                    <td>${formatPct(roi)}</td>
                    <td>${winRate.toFixed(1)}%</td>
                    <td class="pnl-negative">-NT$${t.maxDrawdown.toLocaleString()}</td>
                    <td>${t.maxConsecutiveLoss} æœŸ</td>
                </tr>`;
            });
            document.getElementById('strategyTableBody').innerHTML = tableHTML;
            
            renderPayoutTable(currentStarTarget, isBonusMode);
            document.getElementById('status').innerText = "âœ… 12 ç­–ç•¥çŸ©é™£é‹ç®—èˆ‡æç›Šæ¨¡æ“¬å®Œæˆï¼";

            renderHitChart(labels, trackers);
            renderPnlChart(labels, trackers);
        }

        // é è¨­éš±è—çš„å¯¦é©—ç­–ç•¥ï¼ˆé»æ“Šåœ–ä¾‹å¯é–‹å•Ÿï¼‰
        const HIDDEN_BY_DEFAULT = ['cold', 'overdue', 'antiMarkov', 'prime', 'fibonacci', 'tailDigit', 'dragonTiger'];

        function renderHitChart(labels, trackers) {
            const ctx = document.getElementById('hitChart').getContext('2d');
            if (hitChartInstance) hitChartInstance.destroy();
            const datasets = STRATEGIES.map(s => ({
                label: s.name,
                data: trackers[s.id].hitsData,
                borderColor: s.color,
                backgroundColor: 'transparent',
                tension: 0.3, pointRadius: 0,
                borderWidth: s.isRandom ? 1 : 2,
                borderDash: s.isRandom ? [5, 5] : [],
                hidden: HIDDEN_BY_DEFAULT.includes(s.id)
            }));
            hitChartInstance = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, interaction: { mode: 'index', intersect: false },
                    scales: { x: { ticks: { color: '#94a3b8', maxTicksLimit: 15 } }, y: { ticks: { color: '#94a3b8' } } },
                    plugins: { legend: { labels: { color: '#f8fafc', usePointStyle: true, padding: 15 } } }
                }
            });
        }

        function renderPnlChart(labels, trackers) {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            if (pnlChartInstance) pnlChartInstance.destroy();
            const datasets = STRATEGIES.map(s => ({
                label: s.name,
                data: trackers[s.id].pnlData,
                borderColor: s.color,
                backgroundColor: 'transparent',
                tension: 0.1, pointRadius: 0,
                borderWidth: s.isRandom ? 1 : 2,
                borderDash: s.isRandom ? [5, 5] : [],
                hidden: HIDDEN_BY_DEFAULT.includes(s.id)
            }));
            pnlChartInstance = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, interaction: { mode: 'index', intersect: false },
                    scales: { x: { ticks: { color: '#94a3b8', maxTicksLimit: 15 } }, y: { title: { display: true, text: 'æ·¨ç²åˆ© (NTD)', color: '#94a3b8' }, ticks: { color: '#94a3b8' } } },
                    plugins: { legend: { labels: { color: '#f8fafc', usePointStyle: true, padding: 15 } } }
                }
            });
        }
    </script>
</body>
</html>
