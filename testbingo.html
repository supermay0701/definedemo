<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–ç­–ç•¥å›æ¸¬ç³»çµ± 2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: #f8fafc; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #334155; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #2563eb; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #0f172a; color: white; width: 80px; font-size: 16px;}
        .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 1.1em; background: #0f172a; padding: 15px; border-radius: 8px;}
        .hot { color: #ef4444; } .cold { color: #3b82f6; } .avg { color: #10b981; }
        .prediction-box { display: flex; gap: 20px; margin-top: 20px; }
        .pred-card { flex: 1; background: #0f172a; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #334155;}
        .pred-numbers { font-size: 1.5em; font-weight: bold; margin-top: 10px; letter-spacing: 2px;}
        .ball { display: inline-block; width: 35px; height: 35px; line-height: 35px; border-radius: 50%; background: #e2e8f0; color: #0f172a; margin: 0 3px; font-size: 0.6em;}
    </style>
</head>
<body>
    <div class="container">
        <h2>Bingo ç­–ç•¥å›æ¸¬å¼•æ“ (Edge Compute)</h2>
        <div class="panel">
            <label>API æŠ“å–æ­·å²ç­†æ•¸: <input type="number" id="fetchLimit" value="500"></label>
            <label style="margin-left: 20px;">æ»‘å‹•çª—å£å¤§å° (æœŸ): <input type="number" id="windowSize" value="10"></label>
            <button style="margin-left: 20px;" onclick="runBacktest()">åŸ·è¡Œé‹ç®—èˆ‡å›æ¸¬</button>
            <p id="status" style="color: #94a3b8; font-size: 0.9em; margin-top: 15px;">ç­‰å¾…æŒ‡ä»¤...</p>
        </div>
        
        <div class="panel" id="predictionPanel" style="display: none;">
            <h3 style="margin-top: 0; color: #f8fafc; border-bottom: 1px solid #334155; padding-bottom: 10px;">ğŸ¯ æœ€æ–°ä¸€æœŸé æ¸¬å»ºè­° (åŸºæ–¼æœ€æ–°æ­·å²æ•¸æ“š)</h3>
            <div class="prediction-box">
                <div class="pred-card">
                    <div class="hot">ğŸ”¥ å‹•é‡ç­–ç•¥ (è¿½ç†±é–€)</div>
                    <div class="pred-numbers hot" id="predHot"></div>
                </div>
                <div class="pred-card">
                    <div class="cold">â„ï¸ å‡å€¼å›æ­¸ (è²·å†·é–€)</div>
                    <div class="pred-numbers cold" id="predCold"></div>
                </div>
                <div class="pred-card">
                    <div class="avg">âš–ï¸ å¤§æ•¸æ³•å‰‡ (è¶¨è¿‘å¹³å‡)</div>
                    <div class="pred-numbers avg" id="predAvg"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <canvas id="backtestChart" width="1000" height="400"></canvas>
            <div class="stats" id="finalStats"></div>
        </div>
    </div>

    <script>
        // ğŸš¨ è¨˜å¾—æ›¿æ›ç‚ºä½ çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        let chartInstance = null;

        function formatBalls(arr) {
            return arr.map(num => `<span class="ball">${num < 10 ? '0'+num : num}</span>`).join('');
        }

        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const limit = parseInt(document.getElementById('fetchLimit').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);
            
            statusEl.innerText = "æ­£åœ¨å¾ Google é›²ç«¯æå–é‡åŒ–è³‡æ–™...";
            document.getElementById('predictionPanel').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                
                if (!resJson.success) throw new Error(resJson.error);
                const data = resJson.data;
                
                if (data.length <= windowSize) {
                    statusEl.innerText = `ğŸš¨ éŒ¯èª¤ï¼šè³‡æ–™é‡ä¸è¶³ã€‚æ‚¨è¦æ±‚æŠ“å– ${limit} ç­†ï¼Œå¯¦éš›å–å¾— ${data.length} ç­†ï¼Œä¸è¶³ä»¥æ”¯æ’çª—å£å¤§å° ${windowSize}ã€‚è«‹å…ˆç¢ºèª Google Sheet ä¸­æ˜¯å¦æœ‰è¶³å¤ è³‡æ–™ã€‚`;
                    return;
                }

                statusEl.innerText = `âœ… æˆåŠŸè¼‰å…¥ ${data.length} ç­†è³‡æ–™ã€‚é–‹å§‹åŸ·è¡Œé‚Šç·£é‹ç®—èˆ‡æ­·å²å›æ¸¬...`;
                executeStrategies(data, windowSize);
                
            } catch (error) {
                statusEl.innerText = `ğŸš¨ é€£ç·šéŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize) {
            let labels = [];
            let hotCumulativeHits = [];
            let coldCumulativeHits = [];
            let avgCumulativeHits = [];
            
            let hits = { hot: 0, cold: 0, avg: 0 };
            const TOTAL_NUMBERS = 80;
            const DRAW_COUNT = 20;
            
            // 1. æ­·å²å›æ¸¬çŸ©é™£é‹ç®— (é©—è­‰æ¨¡å‹æœ‰æ•ˆæ€§)
            for (let i = windowSize; i < data.length; i++) {
                const historyWindow = data.slice(i - windowSize, i);
                const targetDraw = new Set(data[i].numbers); 
                labels.push(data[i].id);

                let freqMap = {};
                for (let n = 1; n <= TOTAL_NUMBERS; n++) freqMap[n] = 0;
                historyWindow.forEach(row => { row.numbers.forEach(num => { if (freqMap[num] !== undefined) freqMap[num]++; }); });

                const hotPred = Object.keys(freqMap).sort((a, b) => freqMap[b] - freqMap[a]).slice(0, 5).map(Number);
                const expectedCount = windowSize * (DRAW_COUNT / TOTAL_NUMBERS);
                const coldPred = Object.keys(freqMap).filter(k => freqMap[k] > 0 && freqMap[k] < expectedCount * 0.8).sort((a, b) => freqMap[a] - freqMap[b]).slice(0, 5).map(Number);
                const avgPred = Object.keys(freqMap).sort((a, b) => Math.abs(freqMap[a] - expectedCount) - Math.abs(freqMap[b] - expectedCount)).slice(0, 5).map(Number);

                hits.hot += hotPred.filter(n => targetDraw.has(n)).length;
                hits.cold += coldPred.filter(n => targetDraw.has(n)).length;
                hits.avg += avgPred.filter(n => targetDraw.has(n)).length;

                hotCumulativeHits.push(hits.hot);
                coldCumulativeHits.push(hits.cold);
                avgCumulativeHits.push(hits.avg);
            }

            // 2. é æ¸¬æœ€æ–°ä¸‹ä¸€æœŸ (çœŸæ­£çš„å¯¦æˆ°æ‡‰ç”¨)
            const latestWindow = data.slice(data.length - windowSize);
            let latestFreqMap = {};
            for (let n = 1; n <= TOTAL_NUMBERS; n++) latestFreqMap[n] = 0;
            latestWindow.forEach(row => { row.numbers.forEach(num => { if (latestFreqMap[num] !== undefined) latestFreqMap[num]++; }); });

            const nextHot = Object.keys(latestFreqMap).sort((a, b) => latestFreqMap[b] - latestFreqMap[a]).slice(0, 5).map(Number);
            const expectedCountNext = windowSize * (DRAW_COUNT / TOTAL_NUMBERS);
            const nextCold = Object.keys(latestFreqMap).filter(k => latestFreqMap[k] > 0).sort((a, b) => latestFreqMap[a] - latestFreqMap[b]).slice(0, 5).map(Number);
            const nextAvg = Object.keys(latestFreqMap).sort((a, b) => Math.abs(latestFreqMap[a] - expectedCountNext) - Math.abs(latestFreqMap[b] - expectedCountNext)).slice(0, 5).map(Number);

            // æ›´æ–°é æ¸¬ UI
            document.getElementById('predHot').innerHTML = formatBalls(nextHot);
            document.getElementById('predCold').innerHTML = formatBalls(nextCold);
            document.getElementById('predAvg').innerHTML = formatBalls(nextAvg);
            document.getElementById('predictionPanel').style.display = 'block';

            // æ›´æ–°å‹ç‡ UI
            const totalPredictions = (data.length - windowSize) * 5; 
            document.getElementById('finalStats').innerHTML = `
                <div class="hot">æ­·å²å‘½ä¸­ç‡: ${((hits.hot / totalPredictions)*100).toFixed(2)}%</div>
                <div class="cold">æ­·å²å‘½ä¸­ç‡: ${((hits.cold / totalPredictions)*100).toFixed(2)}%</div>
                <div class="avg">æ­·å²å‘½ä¸­ç‡: ${((hits.avg / totalPredictions)*100).toFixed(2)}%</div>
            `;
            document.getElementById('status').innerText = "âœ… é‚Šç·£é‹ç®—å®Œæˆï¼çµæœå·²æ¸²æŸ“ã€‚";

            renderChart(labels, hotCumulativeHits, coldCumulativeHits, avgCumulativeHits);
        }

        function renderChart(labels, hotData, coldData, avgData) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ğŸ”¥ å‹•é‡ç­–ç•¥ç´¯ç©å‘½ä¸­', data: hotData, borderColor: '#ef4444', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: 'â„ï¸ å‡å€¼å›æ­¸ç´¯ç©å‘½ä¸­', data: coldData, borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: 'âš–ï¸ å¤§æ•¸æ³•å‰‡ç´¯ç©å‘½ä¸­', data: avgData, borderColor: '#10b981', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: true, title: { display: true, text: 'æœŸæ•¸æ¨é€² (æ™‚é–“æµ)', color: '#94a3b8' }, ticks: { color: '#94a3b8', maxTicksLimit: 20 } },
                        y: { display: true, title: { display: true, text: 'ç´¯ç©å‘½ä¸­çƒæ•¸', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#f8fafc' } } }
                }
            });
        }
    </script>
</body>
</html>
