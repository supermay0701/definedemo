<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Bingo é‡åŒ–ç­–ç•¥å›æ¸¬ç³»çµ± 5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --text: #f8fafc; --text-muted: #94a3b8; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; position: relative; }
        .container { max-width: 1200px; margin: auto; }
        .panel { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* æ§åˆ¶é¢æ¿å€ */
        .controls { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .control-item { display: flex; align-items: center; }
        input, select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: white; font-size: 16px; text-align: center; margin: 0 8px;}
        button { background: #3b82f6; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button.btn-fun { background: #8b5cf6; background-image: linear-gradient(to right, #8b5cf6, #d946ef); width: 100%; margin-top: 10px;}
        button.btn-fun:hover { background-image: linear-gradient(to right, #7c3aed, #c026d3); }
        
        /* é æ¸¬å¡ç‰‡å€ */
        .prediction-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px; }
        .pred-card { background: var(--bg); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column;}
        .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card-markov::before { background: #f59e0b; } .card-streak::before { background: #06b6d4; } .card-combo::before { background: #ec4899; } .card-random::before { background: #10b981; }
        .pred-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; justify-content: center;}
        .desc { font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px; min-height: 40px; line-height: 1.4;}
        .pred-numbers { min-height: 50px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; flex-grow: 1; align-items: center;}
        
        /* çƒé«”è¨­è¨ˆ */
        .ball { display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; border-radius: 50%; font-weight: bold; font-size: 18px; color: #1e293b; box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), inset 2px 2px 6px rgba(255,255,255,0.8); animation: popIn 0.3s ease-out forwards; }
        .ball-markov { background: radial-gradient(circle at 30% 30%, #fcd34d, #f59e0b); }
        .ball-streak { background: radial-gradient(circle at 30% 30%, #67e8f9, #06b6d4); }
        .ball-combo { background: radial-gradient(circle at 30% 30%, #f472b6, #ec4899); color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.5); }
        .ball-random { background: radial-gradient(circle at 30% 30%, #6ee7b7, #10b981); }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        /* çµ±è¨ˆå€ */
        .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 1.1em; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        
        /* Tooltip è¨­è¨ˆ */
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #475569; color: white; font-size: 11px; cursor: help; margin-left: 6px; position: relative; font-family: sans-serif; font-style: italic;}
        .info-icon .tooltip { visibility: hidden; width: 280px; background: #334155; color: #f8fafc; text-align: left; padding: 12px; border-radius: 6px; position: absolute; z-index: 10; bottom: 130%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: normal; box-shadow: 0 4px 10px rgba(0,0,0,0.5); line-height: 1.5; text-shadow: none;}
        .info-icon .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent; }
        .info-icon:hover .tooltip { visibility: visible; opacity: 1; }

        #version-badge { position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.8); color: var(--text-muted); padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 0.85em; border: 1px solid var(--border); }
    </style>
</head>
<body>
    <div id="version-badge">Loading version...</div>

    <div class="container">
        <h2>Bingo çŸ©é™£é‡åŒ–èˆ‡æŠ•è³‡çµ„åˆå¼•æ“ 5.0</h2>
        
        <div class="panel controls">
            <div class="control-item">
                <label>æŠ“å–è¿‘</label> <input type="number" id="fetchDays" value="5" style="width: 50px;"> <label>å¤©è³‡æ–™</label>
                <div class="info-icon">i
                    <span class="tooltip"><b>æŠ“å–å¤©æ•¸ï¼š</b><br>æ±ºå®šå¾è³‡æ–™åº«æ’ˆå–å¤šå°‘æ­·å²æœŸæ•¸ã€‚<br>1å¤©ç´„ 204 æœŸã€‚å¤©æ•¸è¶Šå¤šï¼Œé‹ç®—æ™‚é–“è¶Šé•·ï¼Œä½†å¯æä¾›æ›´å¤§æ¨£æœ¬ä¾›æ¨¡å‹å›æ¸¬ã€‚</span>
                </div>
            </div>
            <div class="control-item">
                <label>æ»‘å‹•è¨“ç·´çª—å£:</label> <input type="number" id="windowSize" value="200" style="width: 70px;"> <label>æœŸ</label>
                <div class="info-icon">i
                    <span class="tooltip"><b>æ»‘å‹•è¨“ç·´çª—å£ (Rolling Window)ï¼š</b><br>é æ¸¬ä¸‹ä¸€æœŸæ™‚ï¼ŒAI æœƒã€Œå›é ­çœ‹ã€å¤šå°‘æœŸçš„æ­·å²è¦å¾‹ã€‚<br>è‹¥è¨­ç‚º 200ï¼ŒAI å°±åªåƒè€ƒæœ€è¿‘ 200 æœŸçš„æ‹–ç‰Œ/é€£èŠæ©Ÿç‡ä¾†é æ¸¬ç¬¬ 201 æœŸã€‚é€™èƒ½è®“æ¨¡å‹é©æ‡‰è¿‘æœŸæ©Ÿç‡çš„å¾®å°è®ŠåŒ–ï¼Œé¿å…è¢«å¤ªä¹…é çš„æ­·å²é›œè¨Šå¹²æ“¾ã€‚</span>
                </div>
            </div>
            <div class="control-item">
                <label>ç›®æ¨™æ˜Ÿæ•¸ç©æ³•:</label> 
                <select id="starSelect">
                    <option value="1">1 æ˜Ÿ (å–®æŒ‘)</option>
                    <option value="2">2 æ˜Ÿ</option>
                    <option value="3">3 æ˜Ÿ</option>
                    <option value="4" selected>4 æ˜Ÿ (é¤Šç‰Œæ¨è–¦)</option>
                    <option value="5">5 æ˜Ÿ</option>
                    <option value="6">6 æ˜Ÿ</option>
                    <option value="8">8 æ˜Ÿ</option>
                    <option value="10">10 æ˜Ÿ (å¤§åŒ…ç‰Œ)</option>
                </select>
                <div class="info-icon">i
                    <span class="tooltip"><b>ç›®æ¨™æ˜Ÿæ•¸ (Target Stars)ï¼š</b><br>å‹•æ…‹æ±ºå®šæ‰€æœ‰æ¼”ç®—æ³•æœ€çµ‚è¼¸å‡ºçš„è™Ÿç¢¼æ•¸é‡ã€‚<br>åœ–è¡¨çš„ç´¯ç©å‘½ä¸­æ•¸ä¹Ÿæœƒè‡ªå‹•æ ¡æº–ï¼Œç¢ºä¿æ‰€æœ‰ç­–ç•¥åœ¨ç›¸åŒçš„ã€Œä¸‹æ³¨æ•¸é‡ã€ä¸‹é€²è¡Œå…¬å¹³ç«¶çˆ­ã€‚</span>
                </div>
            </div>
            <button onclick="runBacktest()">ğŸš€ åŸ·è¡Œæ·±åº¦å›æ¸¬èˆ‡é æ¸¬</button>
            <p id="status" style="color: var(--text-muted); width: 100%; margin: 10px 0 0 0;">ç³»çµ±é–’ç½®ä¸­...</p>
        </div>
        
        <div class="panel" id="predictionPanel" style="display: none;">
            <h3>ğŸ¯ é‡åŒ–æŠ•è³‡çµ„åˆå»ºè­° (åŸºæ–¼æœ€æ–°ä¸€æœŸæ­·å²å›æ¨)</h3>
            <div class="prediction-box">
                <div class="pred-card card-markov">
                    <div class="pred-title" style="color: #f59e0b;">ğŸ”— æ¢ä»¶æ©Ÿç‡ (æ‹–ç‰Œ) 
                        <div class="info-icon" style="background:#f59e0b; color:#fff;">i
                            <span class="tooltip" style="color:#fff;"><b>é¦¬å¯å¤«è½‰ç§»çŸ©é™£ P(B|A)ï¼š</b><br><br>ç³»çµ±æƒæè¨“ç·´çª—å£å…§ï¼Œåªè¦æ­·å²ä¸Šå‡ºç¾éèˆ‡ã€Œæœ€æ–°ä¸€æœŸã€é‡ç–Šçš„è™Ÿç¢¼ï¼Œå°±æœƒç´€éŒ„å®ƒå€‘çš„ã€ä¸‹ä¸€æœŸã€é–‹å‡ºäº†ä»€éº¼ã€‚<br><br>åŠ æ¬Šè¨ˆåˆ†å¾Œï¼Œé¸å‡ºæ­·å²ä¸Šæœ€å®¹æ˜“è¢«ç•¶å‰è™Ÿç¢¼ã€Œæ‹–ã€å‡ºä¾†çš„è·Ÿå±èŸ²ã€‚</span>
                        </div>
                    </div>
                    <div class="desc">æ­·å²æ•¸æ“šä¸­ï¼Œè¢«ç•¶å‰è™Ÿç¢¼å¼·çƒˆå¸å¼•å‡ºåœŸçš„è·Ÿå±èŸ²è™Ÿç¢¼ã€‚</div>
                    <div class="pred-numbers" id="predMarkov"></div>
                </div>
                <div class="pred-card card-streak">
                    <div class="pred-title" style="color: #06b6d4;">ğŸ§² è‡ªç›¸é—œæ€§ (é€£èŠ)
                        <div class="info-icon" style="background:#06b6d4; color:#fff;">i
                            <span class="tooltip" style="color:#fff;"><b>æ™‚é–“åºåˆ—è‡ªç›¸é—œæ€§ (Autocorrelation)ï¼š</b><br><br>ç³»çµ±è¨ˆç®—æ­·å²ä¸Šæ‰€æœ‰è™Ÿç¢¼ã€Œé€£çºŒå‡ºç¾2æœŸã€çš„å­˜æ´»ç‡ã€‚<br><br>ç‰¹åˆ¥é‡å°ã€Œæœ¬æœŸå‰›é–‹å‡ºã€çš„ 20 é¡†çƒçµ¦äºˆæ¬Šé‡åŠ æˆï¼Œå¹«ä½ æ‰¾å‡ºç•¶ä¸‹é€£èŠå‹•èƒ½æœ€å¼·çš„è™Ÿç¢¼ç•™å–®ã€‚</span>
                        </div>
                    </div>
                    <div class="desc">å¾å‰›é–‹å‡ºçš„çƒä¸­ï¼Œæ‰¾å‡ºå…·å‚™æœ€å¼·ã€Œå­˜æ´»å‹•èƒ½ã€çš„è™Ÿç¢¼ã€‚</div>
                    <div class="pred-numbers" id="predStreak"></div>
                </div>
                <div class="pred-card card-combo">
                    <div class="pred-title" style="color: #ec4899;">ğŸŒŸ ç¶œåˆå…±æŒ¯ (ç©©å®šé¤Šç‰Œ)
                        <div class="info-icon" style="background:#ec4899; color:#fff;">i
                            <span class="tooltip" style="color:#fff;"><b>å¤šå› å­æ’åæ•´åˆ (Rank Ensemble)ï¼š</b><br><br>å°‡ã€Œæ‹–ç‰Œæ’åã€èˆ‡ã€Œé€£èŠæ’åã€ç›¸åŠ ã€‚<br>åæ¬¡ç¸½å’Œè¶Šå°ï¼Œä»£è¡¨è©²è™Ÿç¢¼åŒæ™‚å…·å‚™ã€å¼·å‹¢æ‹–ç‰Œæš—ç¤ºã€èˆ‡ã€é«˜é€£èŠå­˜æ´»ç‡ã€ã€‚<br><br>æ­¤ç‚ºæ•¸å­¸ä¸Šæœ€ç©©å›ºçš„äº¤é›†ï¼Œæ¥µåº¦é©åˆè¨­å®šç‚º 4 æ˜Ÿä¸¦é€£å‡¹ 10 æœŸã€‚</span>
                        </div>
                    </div>
                    <div class="desc">é›™é‡æ¬Šé‡äº¤é›†ã€‚çµåˆæ‹–ç‰Œèˆ‡é€£èŠå„ªå‹¢ï¼Œæ‰¾å‡ºæ•¸å­¸ä¸Šé˜²ç¦¦åŠ›æœ€å¼·çš„çµ„åˆã€‚</div>
                    <div class="pred-numbers" id="predCombo"></div>
                </div>
                <div class="pred-card card-random">
                    <div class="pred-title" style="color: #10b981;">ğŸ² é‡å­åç¸® (é›»è…¦ççŒœ)
                        <div class="info-icon" style="background:#10b981; color:#fff;">i
                            <span class="tooltip" style="color:#fff;"><b>é«˜ç†µéš¨æ©Ÿæ•¸ç”Ÿæˆ (High-Entropy RNG)ï¼š</b><br><br>äººé¡å¤§è…¦é¸è™Ÿæœƒè‡ªå¸¶åè¦‹ (ä¾‹å¦‚åˆ»æ„é¿é–‹é€£è™Ÿæˆ–ç‰¹å®šå½¢ç‹€)ã€‚<br><br>æ­¤åŠŸèƒ½ç”±ç€è¦½å™¨åº•å±¤ç´”ç²¹çš„ Math.random() é©…å‹•ï¼Œæ‰“ç ´çµ±è¨ˆè¿·æ€ï¼ŒæŠŠå‘½é‹äº¤çµ¦å®‡å®™çš„ç†µã€‚</span>
                        </div>
                    </div>
                    <div class="desc">æ”¾æ£„æ•¸å­¸ï¼Œç´”ç²¹æ©Ÿç‡ã€‚æ‰“ç ´äººè…¦é¸è™Ÿåè¦‹ï¼Œæ¸¬è©¦ä½ çš„çµ•å°é‹æ°£ã€‚</div>
                    <div class="pred-numbers" id="predRandom"></div>
                    <button class="btn-fun" onclick="generateRandom()">ğŸ”® é‡æ–°åç¸®</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3 style="margin-bottom: 10px;">ğŸ“ˆ æ­·å²ç´¯ç©å‘½ä¸­èµ°å‹¢åœ– (æ¨¡å‹æ–œç‡æª¢å®š)
                <div class="info-icon">i
                    <span class="tooltip"><b>å¦‚ä½•çœ‹æ‡‚æ­¤åœ–ï¼Ÿ</b><br><br>1. æ©«è»¸æ˜¯æœŸæ•¸ï¼Œç¸±è»¸æ˜¯è©²ç­–ç•¥ç´¯ç©çŒœä¸­çš„çƒæ•¸ã€‚<br>2. <b>æ–œç‡è¶Šé™¡</b>ï¼Œä»£è¡¨è©²ç­–ç•¥æŠ“ç‰Œè¶Šæº–ã€‚<br>3. è™›ç·šæ˜¯ã€Œé–‰è‘—çœ¼ç›ççŒœã€çš„åŸºæº–ç·šã€‚<br>4. åªè¦å¯¦ç·šèƒ½å¤ ã€Œç©©å®šä¸”æŒçºŒåœ°ã€ç”©é–‹è™›ç·šå¾€ä¸Šæšï¼Œå°±ä»£è¡¨è©²æ•¸å­¸æ¨¡å‹æ‰¾åˆ°äº†è³­å ´æ¼”ç®—æ³•çš„ç ´ç¶»ï¼</span>
                </div>
            </h3>
            <p style="font-size: 0.85em; color: var(--text-muted); margin-top:0;">*æ¯”è¼ƒç›¸åŒæ˜Ÿæ•¸ä¸‹ï¼Œå„ç­–ç•¥çš„ç´¯ç©å‘½ä¸­æ•¸ã€‚æ–œç‡è¶Šé™¡ä»£è¡¨æŠ“ç‰ŒåŠ›è¶Šå¼·ã€‚è‹¥å¯¦ç·šç„¡æ³•ç”©é–‹è™›ç·šï¼Œä»£è¡¨è©²ç­–ç•¥ç­‰åŒççŒœã€‚</p>
            <canvas id="backtestChart" width="1000" height="350"></canvas>
            <div class="stats" id="finalStats"></div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸš¨ é€™è£¡å¿…é ˆæ‰‹å‹•æ›¿æ›ç‚ºä½ æœ€æ–°çš„ GAS Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxmeB5viK8rZz1UgAHu1BwjKISTjOM_TiNddi00sl6SMzfKIT0hRz2HPtprld942VF3/exec"; 
        const APP_VERSION = "v5.0.0 (Portfolio & Tooltip Edition)"; 
        // ============================================

        document.getElementById('version-badge').innerText = APP_VERSION;
        let chartInstance = null;
        let currentStarTarget = 4;

        function formatBalls(arr, styleClass) {
            return arr.map(num => `<div class="ball ${styleClass}">${num < 10 ? '0'+num : num}</div>`).join('');
        }

        // --- æ ¸å¿ƒæ¼”ç®—æ³•åº« ---

        function getMarkovRank(history, currentDraw) {
            let nextCounts = new Array(81).fill(0);
            for (let i = 0; i < history.length - 1; i++) {
                let prev = history[i].numbers;
                let next = history[i+1].numbers;
                let matchWeight = currentDraw.filter(n => prev.includes(n)).length;
                if (matchWeight > 0) {
                    next.forEach(num => nextCounts[num] += matchWeight);
                }
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            return indices.sort((a, b) => nextCounts[b] - nextCounts[a]);
        }

        function getStreakRank(history, currentDraw) {
            let survivalRates = {};
            for (let n = 1; n <= 80; n++) {
                let appearCount = 0;
                let survivedCount = 0;
                for (let i = 0; i < history.length - 1; i++) {
                    if (history[i].numbers.includes(n)) {
                        appearCount++;
                        if (history[i+1].numbers.includes(n)) survivedCount++;
                    }
                }
                let baseRate = appearCount > 0 ? (survivedCount / appearCount) : 0;
                survivalRates[n] = currentDraw.includes(n) ? baseRate * 1.5 : baseRate * 0.5; 
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            return indices.sort((a, b) => survivalRates[b] - survivalRates[a]);
        }

        function getEnsembleRank(markovRank, streakRank) {
            let combinedScores = {};
            for (let i = 1; i <= 80; i++) {
                let mRank = markovRank.indexOf(i);
                let sRank = streakRank.indexOf(i);
                combinedScores[i] = mRank + sRank; 
            }
            let indices = Array.from({length: 80}, (_, i) => i + 1);
            return indices.sort((a, b) => combinedScores[a] - combinedScores[b]);
        }

        function generateRandom() {
            let nums = [];
            while(nums.length < currentStarTarget) {
                let r = Math.floor(Math.random() * 80) + 1;
                if(!nums.includes(r)) nums.push(r);
            }
            nums.sort((a, b) => a - b);
            document.getElementById('predRandom').innerHTML = formatBalls(nums, 'ball-random');
            return nums;
        }

        // --- ä¸»æµç¨‹èˆ‡å›æ¸¬ ---

        async function runBacktest() {
            const statusEl = document.getElementById('status');
            const days = parseInt(document.getElementById('fetchDays').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);
            currentStarTarget = parseInt(document.getElementById('starSelect').value);
            
            const limit = days * 205; 
            
            statusEl.innerText = `â³ æ­£åœ¨å¾é›²ç«¯æå–è¿‘ ${days} å¤© (ç´„ ${limit} æœŸ) çš„è³‡æ–™...`;
            document.getElementById('predictionPanel').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?limit=${limit}`);
                const resJson = await response.json();
                if (!resJson.success) throw new Error(resJson.error);
                
                const data = resJson.data;
                if (data.length <= windowSize) {
                    statusEl.innerText = `ğŸš¨ éŒ¯èª¤ï¼šè³‡æ–™åº«ç­†æ•¸ä¸è¶³ã€‚æ‚¨è¦æ±‚çš„è¨“ç·´çª—å£ç‚º ${windowSize} æœŸï¼Œä½†åªæŠ“åˆ° ${data.length} æœŸã€‚`;
                    return;
                }

                statusEl.innerText = `âœ… æˆåŠŸè¼‰å…¥ ${data.length} æœŸè³‡æ–™ã€‚é–‹å§‹åŸ·è¡Œå¤šå› å­çŸ©é™£å›æ¸¬ (ç›®æ¨™: ${currentStarTarget} æ˜Ÿ)...`;
                
                setTimeout(() => executeStrategies(data, windowSize), 50);
                
            } catch (error) {
                statusEl.innerText = `ğŸš¨ é€£ç·šéŒ¯èª¤: ${error.message}`;
            }
        }

        function executeStrategies(data, windowSize) {
            let labels = [];
            let markovHitsData = [];
            let streakHitsData = [];
            let comboHitsData = [];
            let randomHitsData = [];
            
            let hits = { markov: 0, streak: 0, combo: 0, random: 0 };
            
            for (let i = windowSize; i < data.length; i++) {
                const historyWindow = data.slice(i - windowSize, i); 
                const currentDraw = data[i-1].numbers; 
                const targetDraw = new Set(data[i].numbers); 
                labels.push(data[i].id);

                const mRank = getMarkovRank(historyWindow, currentDraw);
                const sRank = getStreakRank(historyWindow, currentDraw);
                const cRank = getEnsembleRank(mRank, sRank);
                
                // å‹•æ…‹æ ¹æ“šé¸å®šæ˜Ÿæ•¸åˆ‡å‡ºé æ¸¬çƒæ•¸
                const markovPred = mRank.slice(0, currentStarTarget);
                const streakPred = sRank.slice(0, currentStarTarget);
                const comboPred  = cRank.slice(0, currentStarTarget);
                // ç”¢ç”ŸççŒœé æ¸¬ï¼Œæ³¨æ„é€™è£¡ä¸èƒ½ç›´æ¥æ“ä½œ DOM
                let randomPred = [];
                while(randomPred.length < currentStarTarget) {
                    let r = Math.floor(Math.random() * 80) + 1;
                    if(!randomPred.includes(r)) randomPred.push(r);
                }

                hits.markov += markovPred.filter(n => targetDraw.has(n)).length;
                hits.streak += streakPred.filter(n => targetDraw.has(n)).length;
                hits.combo += comboPred.filter(n => targetDraw.has(n)).length;
                hits.random += randomPred.filter(n => targetDraw.has(n)).length;

                markovHitsData.push(hits.markov);
                streakHitsData.push(hits.streak);
                comboHitsData.push(hits.combo);
                randomHitsData.push(hits.random);
            }

            // å¯¦æˆ°é æ¸¬æœ€æ–°ä¸€æœŸ
            const latestHistory = data.slice(data.length - windowSize);
            const absoluteCurrentDraw = data[data.length - 1].numbers; 
            
            const finalMRank = getMarkovRank(latestHistory, absoluteCurrentDraw);
            const finalSRank = getStreakRank(latestHistory, absoluteCurrentDraw);
            const finalCRank = getEnsembleRank(finalMRank, finalSRank);
            
            const nextMarkov = finalMRank.slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextStreak = finalSRank.slice(0, currentStarTarget).sort((a,b)=>a-b);
            const nextCombo  = finalCRank.slice(0, currentStarTarget).sort((a,b)=>a-b);

            document.getElementById('predMarkov').innerHTML = formatBalls(nextMarkov, 'ball-markov');
            document.getElementById('predStreak').innerHTML = formatBalls(nextStreak, 'ball-streak');
            document.getElementById('predCombo').innerHTML = formatBalls(nextCombo, 'ball-combo');
            generateRandom(); 
            
            document.getElementById('predictionPanel').style.display = 'block';

            const totalBallsPredicted = (data.length - windowSize) * currentStarTarget; 
            
            document.getElementById('finalStats').innerHTML = `
                <div style="color: #f59e0b">ğŸ”— æ‹–ç‰ŒæŠ“çƒç‡: ${((hits.markov / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #06b6d4">ğŸ§² é€£èŠæŠ“çƒç‡: ${((hits.streak / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: #ec4899">ğŸŒŸ ç¶œåˆå…±æŒ¯æŠ“çƒç‡: ${((hits.combo / totalBallsPredicted)*100).toFixed(2)}%</div>
                <div style="color: var(--text-muted)">ğŸ² ççŒœæŠ“çƒç‡: ${((hits.random / totalBallsPredicted)*100).toFixed(2)}%</div>
            `;
            document.getElementById('status').innerText = "âœ… çŸ©é™£é‹ç®—å®Œæˆï¼å·²ç‚ºæ‚¨ç”¢ç”Ÿæœ€ä½³æŠ•è³‡çµ„åˆã€‚";

            renderChart(labels, markovHitsData, streakHitsData, comboHitsData, randomHitsData);
        }

        function renderChart(labels, markovData, streakData, comboData, randomData) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: `ğŸ”— æ‹–ç‰Œ (${currentStarTarget}æ˜Ÿ)`, data: markovData, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: `ğŸ§² é€£èŠ (${currentStarTarget}æ˜Ÿ)`, data: streakData, borderColor: '#06b6d4', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: `ğŸŒŸ ç¶œåˆå…±æŒ¯ (${currentStarTarget}æ˜Ÿ)`, data: comboData, borderColor: '#ec4899', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 3 },
                        { label: `ğŸ² åŸºæº–ç·š (é–‰çœ¼ççŒœ)`, data: randomData, borderColor: '#475569', borderDash: [5, 5], backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 15 } },
                        y: { display: true, title: { display: true, text: 'ç´¯ç©å‘½ä¸­ç¸½çƒæ•¸', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#f8fafc' } } }
                }
            });
        }
    </script>
</body>
</html>
